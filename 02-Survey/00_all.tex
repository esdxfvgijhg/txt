\section{All}

\onecolumn
\setlength{\hoffset}{-.5in}
% \pagestyle{empty}

Hetrogeneity of appplications -> network adaptability to different application
network slicing is a sollution to 
-> fixed slicing strategies to maximize resource allocation efficiency
-> (on-demand) dynamic slicing strategies maximize resource allocation efficiency

ultra-reliable low-latency communications (URLLC), 
enhanced mobile broadband (eMBB),
and massive machine-type communications (mMTC))

\begin{longtable}{lllll}
	Year  & \                                              & \textbf{Factors}           & \textbf{Computation Model}             & \textbf{Results interpretation}                               \\\hline
	2018  & EXPLoRa-SF \cite{cuomo_explora_2017}           & connected nodes            & Estimation                             & \textbf{Closeness} have a high degree of                      \\
	\     &                                                & time-on-air                &                                        & Correlation with \textbf{privacy score}                       \\\hline
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
	\     &                                                &                               &                                        &                                                               \\
\caption{ADR solutions}
\end{longtable}

\clearpage
\newpage
\setlength{\hoffset}{-0in}
\twocolumn


\cite{montavont_enhanced_2018}E7535MLG

In this section,
	we present the LoRa/ LoRaWAN technology.
Even if the terms LoRa and LoRaWAN are used interchangeably but they refer to two different concepts in the network.
In fact LoRa corresponds to the PHYSICAL layer and precisely to the modulation technique used and LoRaWAN defines the LoRa MAC layer.
2.1 LoRa Modulation:
	Physical Layer LoRa technology is a proprietary physical modulation designed and patented by Semtech Corporation.
It is based on Chirp-Spread Spectrum (CSS) modulation \cite{springer_spread_2000} with Integrated Forward Error Correction.
LoRa operates in the lower ISM bands (EU: 868 MHz and 433 MHz,
	USA: 915 MHz and 433 MHz).
It offers different configurations (data rates,
	transmission range,
	energy consumption and resilience to noise) according to the selection of four parameters which are Carrier Frequency (CF),
	Bandwidth (BW),
	Coding Rate (CR) and Spreading Factor (SF).
Each LoRa symbol is composed of 2 SF chirps [Project DecodingLoRa],
	where SF represents the corresponding spreading factor in the range of 6 to 12.
SF6 means a shortest range,
	SF12 will be the longest.
Each step up in spreading factor doubles the time on air to transmit the same amount of data.
The use of a larger SF decreases the bit rate and increases the time on Air (ToA) which induces greater power consumption.
In fact,
	in the case of a 125 kHz bandwidth and a coding rate 4/5,
	the bit rate is equal to 250 bps for SF12 and it is equal to 5470 bps for SF7 [LoRa Alliance Technical committee LoRawan regional parameters].
With LoRa,
	transmissions on the same carrier frequency but with different spreading factors are orthogonal,
	so there is no interference.
2.2 LoRaWan:
	LoRa Mac Layer Unlike the proprietary LoRa protocol,
	LoRaWAN is an open protocol defined by LoRa Alliance.
A LoRaWAN network is based on star-of-stars topology and is composed of three elements.
– End devices:
	nodes that send uplink (UL) traffic and receives Downlink (DL) traffic through LoRa gateways.
The communication between end-devices and gateways is based on LoRa modulation.
– LoRa gateways dispatch the LoRaWAN frames received from end devices via IP connections (using Ethernet, 3G, 4G or Wi-Fi,
	etc.) to a network server.

– A network server decodes the packets,
	analyzes information mined by end devices and generate the packets that should be sent to end devices.
LoRaWAN end devices implement three classes:
	a basic LoRaWAN named Class A and optional features (class B,
	class C) \cite{LorawanSpecification}.
LoRaWAN operates in ISM bands (863–870 MHz band in Europe) which are subject to regulations on radio emissions,
	thus radios are required to adopt either a Listen-Before-Talk (LBT) policy or a duty cycled transmission to limit the rate at which the end devices can actually generate messages.
The current LoRaWAN specification exclusively uses duty-cycled limited transmissions to comply with the ETSI regulations [LoRa Alliance Technical committee LoRawan regional parameters].
In fact,
	each device is limited to an aggregated transmit duty cycle of 1\% that means 36 s per hour.

LoRaWAN defines three MAC message types in \cite{LorawanSpecification} which are:
the join message for connecting a device with a network server,
	the confirmed message which have to receive an ACK from a network server,
	and the unconfirmed message without ACK.
A MAC payload length varies between 59 and 250 Bytes depending on the modulation rate [LoRa Alliance Technical committee LoRawan regional parameters].
3 Related Work on LoRa Performance Enhancement In order to optimize the performance of a LoRa network and the quality of service,
	we identified three complementary approaches:
	(1) parameter selection,
	(2) data compression,
	(3) activity time sharing.


3.1 LoRa Parameter Selection As explained in previous section,
	for satisfying a desired performance level,
	one can choose his configuration by combining the various parameters CR (4/5, 4/6, 4/7 and 4/8),
	BW (125 kHz, 250 kHz and 500 kHz),
	SF (from 7 to 12) and TP (2 dBm to 17 dBm),
	resulting in total 1152 combinations.


% -----------------------------------------------------
In \cite{bor_lora_2017} the authors studied the impact of LoRa parameter settings (bandwith,
	coding rate,
	spreading factor,
	transmission power,
	etc.) on energy consumption and communication reliability.
They proposed a mechanism to automatically select LoRa transmission parameters that satisfy the performance requirements.
This solution is optimal for a given application scenario,
	but it is not convenient when traffic dynamically changes.

3.2 Data Compression 

% -----------------------------------------------------
The authors in \cite{jang_swapped_2016} were interested in data compression in order to reduce the size of the data sent and thus minimize the transmission time and optimize the energy consumption.
A swapped huffman tree coding has been applied to transmit the necessary data with a compression ratio of 52.3\%.
Data compression has been used in various LoRa sensors in the industry \cite{LorawanSpecification} in order to reduce energy consumption and thus reduce the data transmission time that will provide better optimization of the LoRa network.
The two studies mentioned above were interested in optimizing energy consumption without worrying about the regulatory constraints relating to the channel occupancy time.

3.3 Activity Time Sharing Mechanism 

% -----------------------------------------------------
\cite{pham_qos_2016},
	proposes a mechanism for sharing the channel occupancy time in order to improve the overall performance of the network.
We give more details on this mechanism,
	to which we are interested in our work.

% -----------------------------------------------------
\cite{pham_qos_2016} proposed an activity time sharing mechanism in a long-range unlicensed LoRa network to face the problem of activity time limitation in the case of video surveillance applications.
The proposed mechanism supposes that all devices that will participate in the sharing mechanism register with the LoRa gateway and announce their local remaining activity time (initially can be the total authorized activity time or just a fraction).
Thus,
	the gateway computes the global activity time allowed for usage which can be an addition of the allowed time of each device “Global Time” (1) or just a fraction of it.
After it informs it to all devices which will share it.
This step is performed each cycle (every hour).
As long as this global activity time allows,
	a node Di that exhausts its duty cycle (allocated activity time) and needs additional time to send its data borrows the remaining time from the global time.
A global view of the total remaining activity time is maintained by the LoRa Gateway (LR-BS) on reception of packets and sent back to devices at the appropriate moments.


GlobalT ime = n × 36 s (1) In \cite{pham_qos_2016},
	the author did not evaluate nor propose a mechanism for selecting devices that will benefit the shared extra time.
Indeed,
	he limited himself to serving the first applicant.


% -----------------------------------------------------
Moreover,
	\cite{pham_qos_2016} assumes that all the nodes participating in the sharing mechanism must be on standby to be able to receive from the gateway the updated information of the global activity time and the list of nodes involved in the loan.
Otherwise they must wake-up periodically to receive this update.
This would not correspond to the behavior of class A nodes but rather to class B nodes.
We believe that the activity time sharing mechanism proposed in \cite{pham_qos_2016} improves the quality of service but lacks an additional time allocation mechanism by a priority classification or a strategy that satisfies a larger number of requesting devices taking into account the range of a device and its battery level in the management of the allocation of additional time.
In the next section,
	we will describe our solution to those above-mentioned issues.

\cite{karmakar_linkcon_2017} QN8Y27W6

In HT-WLANs,
	dynamic link adaptation can be classified into two categories as follows.
(i) Link adaptation in static environment:
	MiRA \cite{pefkianakis_window-based_2013} is a dynamic data rate adaptation approach that selects spatial streams and rates.
It is based on MIMO technology and the receiver’s feedback.
In poor channel condition,
	MiRA performs excessive rate selection.
Further,
	RAMAS \cite{nguyen_practical_2011} is a credit-based scheme that also applies MIMO streams.
So,
	this approach incurs overhead of assigning credit to select data rate.

% -----------------------------------------------------
Deek et al.
\cite{deek_joint_2013} proposed a rate adaptation scheme based on channel bonding.
But,
	the mechanism can not utilize the full strength of all PHY/MAC new features.
Minstrel [Multiband Atheros Driver for WiFi] is the default link adaptation algorithm in Linux system and engages the statistical information for channel overhearing.
However,
	it is suitable only for legacy IEEE 802.11 systems.
Different MCS values and MIMO are used in \cite{das_link_2008} \cite{qiuyan_xia_open-loop_2009}.

% -----------------------------------------------------
Feng et al.
\cite{feng_frame-aggregated_2010} developed a link adaptation scheme that applies frame aggregation.
All these mechanisms do not consider all PHY/MAC enhancements of HT-WLANs along with their internal trade-offs.
Thus,
	these approaches are not able to meet theoretical achievable data rate of IEEE 802.11n/ac in practical scenarios.
Minstrel HT [New Rate Control Module for 802.11n] is the default rate adaptation methodology that is applied by the wireless driver ath9k [-802.11n Wireless Driver].
It perceives the maximum enhancements of PHY/MAC in IEEE 802.11n,
	but suffers from exhaustive sampling.
SampleLite [A Hybrid Approach to 802.11n Link Adaptation] is a pure received signal strength indicator (RSSI) threshold-based algorithm.
It can not cope up with all possible wireless network scenarios.
In one of our previous works \cite{karmakar_dynamic_2015},
	a dynamic link adaptation scheme is designed for IEEE 802.11n.
In this work,
	we consider a limited set of channel conditions measured by RSSI.
In our another work \cite{karmakar_dynamic_2016},
	an adaptive learner is designed for link adaptation in IEEE 802.11ac.
Sur et al.
[Practical MU-MIMO user selection on 802.11ac commodity networks] designed MUSE that is a MU-MIMO-based rate adaptation algorithm for IEEE 802.11ac networks.
ESNR is an another rate selection scheme designed in \cite{halperin_predictable_2010}.
Specifically,
	it was designed for IEEE 802.11n (MIMO).
All new features of HT-WLANs are not employed in MUSE and ESNR.
Moreover,
	their performances were not evaluated in mobile environment.
(ii) Link adaptation in mobile environment:
	As per our knowledge,
	no work has yet considered SDN-based framework to design a dynamic link adaptation algorithm for HT-WLANs in mobile environment.

% -----------------------------------------------------
However,
	Chen et al.
\cite{chen_ram_2012} proposed a rate adaptation algorithm,
	RAM,
	for mobile environment considering only legacy IEEE 802.11 standards.
Hence,
	it is not adjustable with HT-WLANs.

\cite{bor_lora_2017} R2PBNFAQ

Selecting communication parameters of wireless transmitters to reduce energy consumption is a well researched area.
In the Wireless Sensor Networks (WSN) research domain a large amount of research has been undertaken that investigates transmission power control to reduce transmission energy consumption (examples are [Transmission power control techniques for wireless sensor networks],
	\cite{lin_atpc_2006},
	\cite{zurita_ares_power_2007}).
Typical transceivers used for WSNs only provide transmission power as means to influence energy consumption.
Existing algorithms to adjust transmission power depend on probe transmissions;
	often data transmissions double as probe transmissions.
Link quality is either determined by counting lost/erroneous packets over time and/or by estimation using RSSI or Link Quality Indicator (LQI).
Depending on the current link quality,
	transmission power is adjusted.
We follow in our work these established principles.
However,
	LoRa transceivers as used in this work provide additional parameters to influence communication energy cost which we take into account.
Previous work on WiFi and cellular networks has investigated either transmit power control (e.g.
\cite{monks_power_2001},
	\cite{muqattash_single-channel_2004},
	\cite{lin_atpc_2006}),
	transmit rate control (e.g.
\cite{lacage_ieee_2004},
	[sourceforge.net/p/madwiﬁ/svn/HEAD/tree/madwiﬁ/trunk/ ath rate/minstrel/minstrel.txt],
	\cite{wong_robust_2006}),
	or a combination of the two as ‘joint transmit power and rate control’ (e.g.
\cite{ramachandran_symphony_2010},
	\cite{subramanian_joint_2005},
	\cite{chevillat_dynamic_2005}.
Most of the transmit power control is concerned with increasing the capacity,
	and not necessarily the energy consumption.
The transmit rate control is often only concerned with maximising throughput.
Compared to LoRa,
	WiFi data rates and packet rates are significantly higher,
	and the control algorithms run at a much higher rate then what is feasible with LoRa.
For example,
	the most commonly used transmit rate control algorithm Minstrel [sourceforge.net/p/madwiﬁ/svn/HEAD/tree/madwiﬁ/trunk/ ath rate/minstrel/minstrel.txt] evaluates its links every 100 ms.

\cite{cuomo_explora_2017} HNKJMCMR

The current literature on LoRaWAN systems can be divided in three fields:
	i) works dealing with an overview of the current technology and proposing new solutions to optimize its performance [Bor,
	J.
Vidler,
	and U.
Roedig,
	“Lora for the internet of things]\cite{augustin_study_2016};
	ii) papers aiming at analyzing the LoRa capabilities and studying their performance in specific scenarios \cite{voigt_mitigating_2016}\cite{georgiou_low_2017}\cite{mikhaylov_analysis_2016}\cite{reynders_power_2017};
	iii) works defining channel models (through simulations in different environments and scenarios) and emphasizing how these infrastructures are sensitive to the environment in which they operate \cite{petajajarvi_coverage_2015}.
In \cite{bor_lora_nodate},
	the authors present a performance and capability analysis of a currently available LoRa transceiver.
They describe the tranceiver’s features and demonstrate how it can be used efficiently in a wide-area application scenario.
In particular,
	they demonstrate how unique features such as concurrent non-destructive transmissions and carrier detection can be employed.
The experiments demonstrate that six LoRa nodes can form a network covering 1:5:ha in a built up environment,
	achieving a potential lifetime of 2 year on 2 AA batteries,
	delivering data within 5 s with reliability of 80\%.


% -----------------------------------------------------
Conversely,
	the EXPLoRa heuristic \cite{cuomo_explora_2017} aims to efficiently distribute the SFs among end-devices:
	the EXPLoRa-SF tries to equally distribute the SFs among the total number of nodes only constrained by the Receiver Signal Strength Indicator (RSSI) values.
A more sophisticated approach,
	EXPLoRa-AT tries to equalize the Time-on-Air of the transmitted packets among the SF channels.
The solutions presented in this paper are an upgrade of the latter approach by taking into account different traffic areas as well as variable payloads and message periods,
	thereby being able to precisely determine and equalize the traffic load for each SF channel,
	expressed in terms of symbol time.
	

\cite{bor_lora_2016} I4JZZ98I

There is limited published work discussing scalability of LoRa.

% -----------------------------------------------------
Closest to this paper is the work by Petajajarvi et al.
\cite{petajajarvi_coverage_2015} and our own previous work reported in \cite{bor_lora_nodate}.
Petajajarvi et al.
present an evaluation of LoRa link behaviour in open spaces.
We evaluated LoRa link behaviour in built-up environments.
We built upon the results reported in these papers when constructing our communication models for LoRaSim (see Section 3).
This previous work,
	however,
	does not address general scalability questions of LoRa.
A vast number of generic wireless simulation tools such as ns-3 [Modeling and tools for network simulation] or OMNet++ [The OMNeT++ discrete event simulation system] exist.
There are also simulators such as Cooja [Cross-level sensor network simulation with cooja] or TOSSIM [Tossim:
	accurate and scalable simulation of entire tinyos applications] designed for Wireless Sensor Networks (WSN) and IoT environments.
These simulators can be extended by the components designed for our simulator LoRaSim to enable LoRa simulations.
The Semtech LoRa modem calculator [www.semtech.com/apps/ﬁledown/down.php? ﬁle=SX1272LoRaCalculatorSetup1\%271.zip] helps with analysis of LoRa transmission features (airtime of packets,
receiver sensitivity) but does not enable network planning.
Siradel provides a simulation tool called S IOT [www.siradel.com/portfolio-item/alliance-lora].
S IOT relies on Volcano,
	a 3D-ray tracing propagation model and a portfolio of 2D and 3D geodata.
The tool supports sink deployment decisions based on propagation models.
This commercial tool considers the environment to a much greater detail than our simulator LoRaSim.
However,
	it does not take into account actual traffic,
	collisions or details such as capture effect.
Our models provided in Section 3 could be used to improve S IOT.


\cite{bor_lora_2016} I4JZZ98I

There is limited published work discussing scalability of LoRa.

% -----------------------------------------------------
Closest to this paper is the work by Petajajarvi et al.
\cite{petajajarvi_coverage_2015} and our own previous work reported in \cite{bor_lora_nodate}.
Petajajarvi et al.
present an evaluation of LoRa link behaviour in open spaces.
We evaluated LoRa link behaviour in built-up environments.
We built upon the results reported in these papers when constructing our communication models for LoRaSim (see Section 3).
This previous work,
	however,
	does not address general scalability questions of LoRa.
A vast number of generic wireless simulation tools such as ns-3 [Modeling and tools for network simulation] or OMNet++ [The OMNeT++ discrete event simulation system] exist.
There are also simulators such as Cooja [Cross-level sensor network simulation with cooja] or TOSSIM [Tossim:
	accurate and scalable simulation of entire tinyos applications] designed for Wireless Sensor Networks (WSN) and IoT environments.
These simulators can be extended by the components designed for our simulator LoRaSim to enable LoRa simulations.
The Semtech LoRa modem calculator [www.semtech.com/apps/ﬁledown/down.php? ﬁle=SX1272LoRaCalculatorSetup1\%271.zip] helps with analysis of LoRa transmission features (airtime of packets,
receiver sensitivity) but does not enable network planning.
Siradel provides a simulation tool called S IOT [www.siradel.com/portfolio-item/alliance-lora].
S IOT relies on Volcano,
	a 3D-ray tracing propagation model and a portfolio of 2D and 3D geodata.
The tool supports sink deployment decisions based on propagation models.
This commercial tool considers the environment to a much greater detail than our simulator LoRaSim.
However,
	it does not take into account actual traffic,
	collisions or details such as capture effect.
Our models provided in Section 3 could be used to improve S IOT.

Moreover,
	\cite{bor_lora_nodate} describes LoRaBlink,
	an IoT protocol for LoRa transceivers designed to support reliable and energy efficient low-latency bi-directional multi-hop communication.
The work in \cite{augustin_study_2016} provides an overview of LoRa and an indepth analysis of its functional components.
The physical and data link layer performance are evaluated by field tests and simulations.
Based on the analysis and evaluations,
	the authors show that LoRa physical layer,
	thanks to the chirp spread spectrum modulation and high receiver sensitivity,
	offers good resistance to interference.
Field tests show that LoRa can offer satisfactory network coverage up to 3 km in a suburban area with dense residential dwellings.
The SF has significant impact on the network coverage,
	as does the data rate.



However,
	the performance drastically decrease when the link load increases.
Limits and potentialities of LoRaWAN are studied by Voigt et al.
in \cite{voigt_mitigating_2016}.
Through simulations based on real experimental data,
	the paper shows that interference can drastically reduce the performance of a LoRa network.
They also demonstrate that directional antennas and using multiple base stations can improve performance under interference.
Scalability issues in the LoRA system are analyzed in several papers \cite{bor_lora_2016}\cite{georgiou_low_2017}\cite{mikhaylov_analysis_2016}.


% -----------------------------------------------------
Bor et al.
in \cite{bor_lora_2016} provide a LoRa link behaviour by using practical experiments able to describe (i) communication range in dependence of communication settings of SF and Bandwidth (BW) and (ii) capture effect of LoRa transmissions depending on transmission timings and power.
They also provided a LoRa simulator (LoRaSim) and evaluated the LoRa scalability limits in static settings comprising a single sink,
	and assessed how such limits can be overcome with multiple sinks and dynamic communication parameter settings.

% -----------------------------------------------------
A measurement based assessment of LoRa was also carried out in \cite{petajajarvi_coverage_2015},
	which captures the Received Signal Strength Indicator (RSSI) by different locations from the base station and derives an heat map able to characterize performance as a function of the distance and of the environmental conditions (on water and on the groud).
The paper also derives a channel attenuation model based on the presented measurements results.

% -----------------------------------------------------
Empirical evaluations have been also provided in \cite{mikhaylov_lorawan_2017}.

% -----------------------------------------------------
In \cite{georgiou_low_2017} the effects of interference in a single gateway LoRa network have been investigated.
Unlike other wireless networks,
	LoRa employs an adaptive chirp spread spectrum modulation scheme,
	thus extending the communication range in absence of any interference.
Interference is however present when signals simultaneously collide in time,
	frequency,
	and spreading factor.

% -----------------------------------------------------
Leveraging tools from stochastic geometry,
	the authors of \cite{georgiou_low_2017} have formulated and solved two link-outage conditions that can be used to evaluate the LoRA behavior.

% -----------------------------------------------------
Georgiou et al.
in \cite{georgiou_low_2017} showed how the coverage probability drops exponentially as the number of network devices grows due to the interfering signals using the same spreading factor,
	which is concluded to be perhaps the most significant limits towards scalability on LoRa.

% -----------------------------------------------------
The paper \cite{mikhaylov_analysis_2016} analyses the performance of the LoRa LPWAN technology by showing that,
	in accordance to the specifications,
	a single end device located close to the base station can feature an uplink data transfer channel of only 2 kbit/s at best.
In terms of scalability,
	they show that a single LoRaWAN cell can potentially serve several millions of devices sending few bytes of data per day.
Nonetheless,
	they showed that only a small portion of these devices can be located sufficiently far away from the base station.

% -----------------------------------------------------
Finally,
	\cite{reynders_power_2017} and \cite{magrin_performance_2017} derive throughput behavior and capacity limits under some ideal conditions (perfect orthogonality of the SFs).

\cite{cuomo_towards_2018} SG3YQG82

The LoRaWAN has attracted the IoT community as a promising platform for supporting smart city deployments.
Thus,
	throughout the last years,
	different works have analyzed the technology limits and addressed open issues such as scalability.
In this context,
	we can classify the related literature as follows:
	(i) Works analyzing the current capabilities and limitations of LoRaWAN \cite{adelantado_understanding_2017}\cite{petajajarvi_performance_2017}\cite{georgiou_low_2017}\cite{bor_lora_2016},
	and studing its performance under specific settings \cite{magrin_performance_2017}\cite{petajajarvi_evaluation_2017}\cite{varsier_capacity_2017}.
(ii) Papers proposing novel approaches and heuristics to optimize the network performance \cite{bor_lora_nodate}\cite{reynders_power_2017}\cite{abdelfadeel_fair_2018}\cite{sartori_enabling_2017}\cite{cuomo_explora_2017}.
As for the first group,
	Adelantato et al.
surveyed in \cite{adelantado_understanding_2017} the limits of LoRaWAN.
An issue concerns the maximum duty cycle (DC) allowed within the ISM band.
For instance,
	the 1\% for the U E 868 M Hz band turns out into a maximum
transmission time of 36 secs in an hour,
	for each device.
This also limits the LoRa gateways in the down-link channel,
	which have to comply with the DC regulation.
Another important analysis in \cite{adelantado_understanding_2017} regards the use of ALOHA in a LoRaWAN deployment,
	which simplifies the network implementation,
	but at the expense of the throughput that is significantly limited by collisions.

% -----------------------------------------------------
Petäjäjärvi et al.
in \cite{petajajarvi_performance_2017} analyzed the capacity of a LoRaWAN cell.
For applications requiring transmission of only a single packet per day,
	the cell may serve up to millions of devices.
However,
	in case of applications reporting messages every minute,
	only few hundreds of devices may be hosted.

% -----------------------------------------------------
Petäjäjärvi et al.
in \cite{petajajarvi_performance_2017} also evaluated the performance of the LoRa communication under the presence of the doppler shift.
The results concluded that with SF = 12 (which enables the longest range) the communication deteriorates when relative speed exceeds 40 km/h whereas with a lower mobility it can be assured a reliable communication;
	finally,
	it was also evaluated the coverage attained by a LoRa device transmitting with SF = 12 and a transmission power of 14 dBm;
	as a result,
	it was determined the feasibility of communicating within a distance of 2 − 5 km,
	and in a range of 15 − 30 km on the water.

% -----------------------------------------------------
Scalability issues also have been addressed in by Bor et al.
in \cite{bor_lora_2016} where it was identified a LoRa link model for the communication range and the collision behavior.
They also provided the LoRa simulator (LoRaSim) implementing the link behavior model.
In addition,
	it has been of interest the evaluation the LoRaWAN performance in smart city scenarios.

% -----------------------------------------------------
Magrin et al.
in \cite{magrin_performance_2017} implemented a model using the ns-3 simulator to study the performance in a typical urban environment.
It was developed a path loss model where devices inside the buildings may be affected by building penetration losses.
There were executed simulations with thousands of devices following a Pareto distribution.
It was concluded that LoRaWAN with the ADR scheme may scale well only if there are numerous gateways suitably deployed across the system.
i.e.,
	a packet success rate of 95\% for 15000 devices is attained only if there are 75 gateways.

% -----------------------------------------------------
Other works dealt with application-tailored deployments such as in \cite{petajajarvi_evaluation_2017} where it was studied the support of LoRa for health care monitoring,
	or in \cite{varsier_capacity_2017} for hosting smart metering devices.
For optimizing the performance of LoRa,
	many works have addressed the scalability issue.
To this aim,
	several heuristics have been focused on how to efficiently allocate the wireless resources.

% -----------------------------------------------------
Reynders et al.
in \cite{reynders_power_2017} developed a scheme to efficiently assign the SF and the transmission power across the devices.

% -----------------------------------------------------
On the other hand,
	Abdelfadeel et al.
presented in \cite{abdelfadeel_fair_2018} a fair adaptive data rate algorithm (FADR) which computes a data-rate and transmission power allocation in order to achieve fairness in data-rate and reduce collision among nodes.

%------------------------------------------------------
Other efforts for optimizing the network have been done tackling other solutions such as the usage of new LoRa transceivers \cite{bor_lora_nodate} or the development of multi-hop communication for choosing the minimal Time-on-Air path \cite{sartori_enabling_2017}.

\cite{farhad_scalability_2019} RQLF94IS

This section presents the related works regarding SF assignment and analysis of LoRaWAN in both confirmed and unconfirmed mode.
The performance of LoRaWAN network with the only unconfirmed mode in an urban environment is presented in \cite{magrin_performance_2017}.

% -----------------------------------------------------
\cite{magrin_performance_2017} shows an assignment of SF to each ED based on the GW sensitivity by analyzing the radio frequency power signal at the GW.
As a result,
	it lowers the probability of collisions and minimizes the ToA.
Then,
	the GW is chosen based on the received power and SFs are allocated for the transmission.
The GW is configured with 8 received paths with 3 channels in total.
These receiving paths are assigned to each channel for uplink transmission.
However,
	in this work,
	downlink transmission and confirmed mode are not considered.
Another approach,
	RS-LoRa MAC protocol,
	aims to improve the reliability and scalability of LoRaWAN under free space path loss model \cite{reynders_improving_2018}.
RS-LoRa works in two major steps;
	in the first step,
	the GW is responsible for scheduling EDs within its range by measuring the Received Signal Strength Indicator (RSSI) and SF for each channel.
In the second step,
	each ED decides its SF,
	transmission power,
	and channel based on the information provided by the GW.
This scheduling reduces the collision by carefully selecting an SF in order to improve network reliability,
	scalability,
	and capture effect.

% -----------------------------------------------------
In order to tackle the interference and capture effect,
	an error model is described in \cite{abeele_scalability_2017}.
This model is used for determining the range between EDs and a GW as well as analyzing the interference among various concurrent communications.
The algorithm considers three different methods for assigning an efficient SF:
	(i) a random assignment method which assigns SFs based on uniform distribution mechanism,
	(ii) a fixed assignment method which assigns the same SFs all the time during the simulation period,
	(iii) Packet Error Rate (PER) based which finds and allocates the lowest SF for which the PER falls under a certain threshold.
The PER approach for finding a suitable SF performs better than both the random and fixed-based SF assignment methods and can play a vital role in enhancing the packet delivery ratio.
Another work shows the performance of LoRaWAN network by performing a system-level simulation on NS-3 when heterogeneous traffics are transferred for smart metering communication \cite{gupta_modelling_2017}.
The simulation was performed under a single GW located at the densely populated area in combination with multiple buildings of some random heights and sizes.
EDs are distributed uniformly on each floor in the building within a coverage range of 2500 m.
The lowest SFs are assigned according to SNR of ED packets,
	thus it reduces the ToA for each ED and minimizes the chances of interference.
The SF control algorithm is presented by allocating SFs to interact with two types of collisions:
	(a) two packets with the same SF collide and (b) two packets with different SFs collide in \cite{reynders_power_2017}.
Hoverer,
	it fails to provide a solution to the second type.
The primary purpose of this research is to reduce PER,
	improve fairness,
	and the throughput between EDs.
The algorithm sorts the EDs based on distance and path loss to form distinct groups,
	where each group uses a separate channel.
EDs in each group get the same SF based on the distance.
Then the sum of the received power and cumulative interference ratio (CIR) is computed.
If CIR exceeds the highest received power then it passes the feasibility check.
On the other hand,
	the lowest SF is assigned to each group if the CIR is lower than the threshold.
The proposed scheme decreases the PER up to 42\% overall.
An SF allocation scheme for massive LoRaWAN network aims to enhance the success ratio by considering the interference among the same SFs and channel \cite{lim_spreading_2018}.
To identify the interference caused by the collision of two packets,
	it determines the collision overlap time between the packets of the same SFs over the same channel.
Then the SIR and received power are computed.
If it exceeds the threshold,
	then the packets survived from interference.
Otherwise,
	the packets are lost due to interference.
However,
	it ignores any interference occurred due to the different SFs over the same channel,
	because these SFs are not perfectly orthogonal.


\cite{ochoa_large_2018} SGS7P626

Some authors deployed LoRa networks and experimentally studied its performance  \cite{aref_free_2014}
\cite{petajajarvi_coverage_2015-1}
\cite{wixted_evaluation_2016}
\cite{san-um_long-range_2017}
\cite{li_application_2017}.
The measurements were done in city centers,
	tactical troop tracking,
	and sailing monitoring systems.
Nevertheless,
	experimental results in real life networks are not reproducible and MAC layer optimization is difficult.

% -----------------------------------------------------
Blenn et al.
\cite{blenn_lorawan_2017} performed simulations based on traces from experiments and analyzed results based on real life and large scale measurements from The Things Network but their simulations are limited to the deployed scenario.
To and Duda \cite{to_simulation_2018} presented LoRa simulations in NS-3 validated in testbed experiments.
They considered the capture effect and showed the reduction of the packet drop rate due to collisions with a CSMA approach.

% -----------------------------------------------------
In a system level simulator,
	Haxhibeqiri et al.
\cite{jetmir_haxhibeqiri_lora_2017} studied the scalability for LoRaWAN deployments in terms of the number of nodes per gateway.
Simulations are performed for a duty cycle of 1\% but they are limited to 1000 nodes.
We developed a LoRa simulator to compare the performance in different deployment scenarios for large scale networks based on an accurate model of the LoRa PHY/MAC layers.
We simulate several deployment scenarios varying traffic intensity and the number of nodes.
C.
LoRa Evaluation and Limits Several authors evaluated performance and limits of LoRa networks.

% -----------------------------------------------------
Reynders et al.
\cite{reynders_range_2016} evaluated Chirp Spread Spectrum (CSS) and ultra-narrow-band networks.
They proposed a heuristic equation that gives Bit Error Rate (BER) for a CSS modulation as a function of SF and Signal to Noise Ratio (SNR).

% -----------------------------------------------------
Cattani et al.
\cite{marco_cattani_experimental_2017} evaluated the impact of the LoRa physical layer settings on the data rate and energy efficiency.
They evaluated the impact of environmental factors such as temperature on the LoRa network performance and showed that high temperatures degrade the Packet Delivery Ratio (PDR) and Received Signal Strength (RSS).

% -----------------------------------------------------
Goursaud et al.
\cite{goursaud_dedicated_2015} studied the performance of the CSS modulation.
They showed the possibility of interference between different SFs and evaluated co-channel rejection for all combinations of SFs.

% -----------------------------------------------------
Feltrin et al.
\cite{feltrin_lorawan_2018} discussed the role of LoRaWAN for IoT and showed its application to many use cases.
They considered the effect of non perfect orthogonality of SFs for a link level analysis.

% -----------------------------------------------------
Petajajarvi et al.
\cite{petajajarvi_performance_2017} analyzed the scalability of a LoRa wide area network and showed its good coverage (e.g.
until 30km on water for SF12 and transmit power of 14 dBm).
They also showed the maximum throughput for different duty cycles per node per channel.
Mikhaylov et al.
[Analysis of capacity and scalability of the lora and low and power wide and area network and technology] discussed LoRa performance under European frequency regulations.
They studied the performance metrics of a single end device,
	then the spatial distribution of several end devices.
They showed LoRa strengths (large coverage and good scalability for low uplink traffic) and weaknesses (low reliability,
	delays,
	and poor performance of downlink traffic).

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_nodate} presented a capability and performance analysis of a LoRa transceiver and proposed LoRaBlink protocol for link-level parameter adaptation.

% -----------------------------------------------------
Nunez et al.
\cite{ochoa_evaluating_2017} analytically showed the potential gain of adaptive LoRa solutions that choose suitable radio parameters (i.e.,
	spreading factor,
	bandwidth,
	and transmission power) to different deployment topologies (i.e.,
	star and mesh).
These studies provide a first view of LoRa performance and its limitations.
As a conclusion we need to take into account the capture effect and imperfect orthogonality of SFs.
We contribute with an accurate LoRa simulation model considering the co-channel SF interference and the gateway capture effect,
	allowing accurate performance analysis in large scale simulations for different deployment scenarios.
Our study extends the previous evaluations of LoRa limits with the evaluation of reliability,
	network throughput,
	and power consumption from sparse to massive access deployment scenarios.
D.
LoRa Network Deployment Strategies Some authors studied LoRa network deployments and SF allocation strategies.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} studied LoRa transceiver capabilities and the limit supported by LoRa system.
They showed that LoRa networks can scale if they use dynamic selection of transmission parameters.

% -----------------------------------------------------
Georgiou et al.
\cite{georgiou_low_2017} investigated the effects of interference in a network with a single gateway.
They studied two link-outage conditions,
	one based on SNR and the other one based on co-SF interference.
They showed,
	as expected,
	that performance decreases when the number of nodes increases and highlighted the interest of studying spatially heterogeneous deployments.

% -----------------------------------------------------
Croce et al.
\cite{croce_impact_2018} showed the effect of the quasi-orthogonality of SFs and found that overlapped packet transmissions with different SFs may suffer from losses.
They validated the findings by experiments and proposed SIR thresholds for all combinations of SFs.
They remarked that LoRa networks cannot be studied as a superposition of independent networks because of imperfect SF orthogonality.

% -----------------------------------------------------
Abeele et al.
[\cite{abeele_scalability_2017} studied the capacity and scalability of LoRaWAN for thousands of nodes per gateway.
They showed the importance of considering the capture effect and interference models.
They proposed an error model from BER simulations to determine communication ranges and interference.
They also analyzed three strategies of network deployments (random SF allocation,
	a fixed one,
	and according to related PDR),
	the last one presenting the best performance.

% -----------------------------------------------------
Lim et al.
\cite{lim_spreading_2018} analyzed the LoRa technology to increase packet success probability and proposed three SF allocation schemes (equal interval based,
	equal area based,
	and random based).
They found that the equal area scheme results in better performance compared with other schemes because of the reduced influence of SFs.
The state of the art indicates the interest in heterogeneous deployments and SF allocation strategies.
Thus,
	we analyze homogeneous and heterogeneous deployments with different SF allocations as a function of the number of nodes and traffic intensity in order to show network performance and the benefits of heterogeneity for large scale networks.

\cite{orfanidis_investigating_2017} 4KSQ7ABK

There are numerous LPWAN technologies emerging.
LoRa,
	in particular,
	has attracted both research and industry interest because of its long range and robust performance.
Existing research mostly focuses on LoRas performance,
	especially its transmission range,
	capacity,
	and scalability and on interaction between LoRa transmissions.

% -----------------------------------------------------
They include [LoRa transmission parameter selection] \cite{augustin_study_2016} [LoRa from the city to the mountains:
	Exploration of hardware and environmental factors],
	where the authors evaluate LoRa performance under various set of configurations and conditions.

% -----------------------------------------------------
For instance,
	\cite{bor_lora_2017} introduces an algorithm for selecting proper parameters considering a desired energy consumption and link quality.
In [LoRa from the city to the mountains:
	Exploration of hardware and environmental factors],
	a measurement study shows that vegetation has a big impact on LoRa transmissions.
The Spreading Factor (SF) and the transmission data rate have a significant impact on the network coverage according to \cite{augustin_study_2016}.

% -----------------------------------------------------
LoRa scalability is investigated in \cite{georgiou_low_2017}\cite{voigt_mitigating_2016}\cite{adelantado_understanding_2017}.
The authors in \cite{georgiou_low_2017} analyze a LoRa network using a single gateway.
Their results show that with an increase in the number of enddevices,
	the coverage probability drops exponentially,
	due to their interfering signals.

% -----------------------------------------------------
In \cite{voigt_mitigating_2016},
	simulation is used to show that multiple base stations improves the network performance under interference.

% -----------------------------------------------------
In \cite{adelantado_understanding_2017},
	the authors focus on the performance impact of LoRa on higher layers.
otably from their work is that the down-link receive window is seen as the limiting factor.
This work,
	like the others,
	identifies that the main scalability limit of LoRa is its channel access protocol (essentially ALOHA) together with its rather expensive packet acknowledgements.

% -----------------------------------------------------
Finally,
	the work most closely related to ours is \cite{mikhaylov_lorawan_2017},
	an empirical study of interference between LoRa networks (a pre-print at the time of this writing).
The paper investigates the interference case when one LoRa radio uses conventional LoRa modulation and the other one uses 2-GFSK modulation,
	which is also used in IEEE 802.15.4g.
(Support for 2-GFSK is required in the LoRa specification.) The experiments use randomized packet lengths and inter-arrival times for both the sender and the interferer.
The inter-arrival times are a significant fraction of (and in some cases longer than) the packet transmission times.
This means that the proportion of time that the channel is interfered varies depending on the choice of LoRa transmission parameters.
As a consequence,
	the results reflect a mix of heavily and minimally interfered packets.
It is therefore hard to draw conclusions about the interference behavior,
	beyond the specific empirical observations.
By contrast,
	we are doing much more controlled experiments that allow us to examine the interaction between the two modulations in detail.

\cite{reynders_power_2017} 2ILCWX9Z

As described above,
	CSS enables decoding multiple messages with different spreading factors simultaneously.
To decode simultaneous transmissions,
	power control is important because a threshold SNR needs to be guaranteed which is only possible when the received powers of all simultaneously transmitting nodes are of the same magnitude.
Code Division Multiple Access (CDMA) is also a spread spectrum technique in which power control is a well investigated topic towards 3G cellular networks.
Different algorithms exist:
	BER-based [Transmitter power control with adaptive safety margins based on duration outage],
	SNR-based [Power control in wireless networks:
	A survey] and RSSI-based [Location based power control for mobile devices in a cellular network].
In our scenario however,
	we cannot use the SNRor BER-based solutions,
	as they require fast feedback.
In 3G networks,
	the update rate is 800Hz,
	while in LoRaWAN only one downlink message is available for each uplink message.

% -----------------------------------------------------
Finally,
	interesting research has been done concerning random access.
\cite{dhillon_fundamentals_2014} has shown the limits for random access networks with respect to retransmission probabilities and optimization of throughput given some failure constraints.
This paper is different in the sense that the goal of our optimization is not throughput but packet error rate fairness.

\cite{reynders_lorawan_2018} MWBMBZYE


% -----------------------------------------------------
Many work has been done in estimating the performance of LoRA networks,
	such as \cite{adelantado_understanding_2017} \cite{augustin_study_2016} \cite{mikhaylov_analysis_2016}.
Although their conclusions are interesting,
	they only use a simpliied MAC protocol.
This calls for a powerful network simulator that is useful to study the real network performance.
Several simulation tools have been proposed for LoRaWAN.
The most well-known LoRaWAN simulator is the LoRaSim built with python \cite{bor_lora_2016} \cite{voigt_mitigating_2016}.
It is open source and gives great insights in the LoRaWAN performance.
However,
	LoRaSim does not implement acknowledgments.
Thus,
	it cannot be used to study the network performance where nodes switch their spreading factor based on the feedback or absence of feedback from the gateway.
Similarly,
	an Omnet++ implementation has been proposed in [Adaptive Coniguration of LoRa Networks for Dense IoT Deployments].
It implements an Automatic Data Rate (ADR) scheme where nodes can update their spreading factor and power at runtime.
For ns-3,
	two diferent modules have been proposed in literature.

% -----------------------------------------------------
The authors in \cite{magrin_performance_2017} proposed a complete LoRa module.
It features MAC commands,
	diferent overlapping networks and multigateway support.
Besides these interesting features,
	this module has some drawbacks.
First,
	it can only send LoRa messages,
	so it is impossible to simulate the efect of interference.
Next,
	similar chirp rates do not have efect on each other.
Due to the chirp spread spectrum technique,
	spreading factor 9 with 125 kHz bandwidth has a similar chirp rate compared to spreading factor 11 with a 250 kHz bandwidth.
Another small drawback is that all the gateways in this model are virtually directly connected to the network server,
	so the packets cannot be routed over IP.

% -----------------------------------------------------
Independently from the previous implementation,
	the authors in \cite{abeele_scalability_2017} have proposed their solution.
Their proposal also supports multiple gateways and overlapping networks.
However,
	they did not include MAC commands.
With their solution,
	interfering networks are possible as they accept interference from any network working on the same channel and frequency.
Also in this implementation,
	the network is not connected to the IP layer,
	but directly to gateways.
Compared to the above models,
	our implementation is totally compliant with the LoRaWAN v1.0 class A speciication.
It is highly conigurable.
Its lexible backbone architecture allows for easy integration of new protocols.
Our model supports distributed gateways that are connected over an IP network to the network server that controls the whole network.
We also provide base classes for the easy implementation of new applications on the network server and new MAC commands.
With this model,
	we have investigated many aspects of LoRa networks,
	such as the efect of diferent spreading factors \cite{reynders_power_2017},
	the efect of interference \cite{reynders_range_2016},
	the reliability and scalability \cite{reynders_improving_2018},
	etc.
Our model can also be used to study the efect of downlink messages \cite{pop_does_2017} and multiple gateways \cite{abeele_scalability_2017} \cite{voigt_mitigating_2016}.

\cite{bouguera_energy_2018} P3CSS7S2

LoRa and LoRaWAN technologies are relatively recent standards \cite{augustin_study_2016}.
Most existing research based on LoRa and LoRaWAN has focused on features such as delay,
	range,
	throughput and network capacity \cite{bor_lora_2017} \cite{augustin_study_2016}\cite{jetmir_haxhibeqiri_lora_2017}\cite{nolan_evaluation_2016}.
Since the LoRa modulation is deployed for sensor applications,
	several papers evaluated this new technology with respect to its energy consumption.
Driven by the challenges of energy consumption of wireless sensor applications,
	many recent works have focused on the power dissipation of communicating sensors.

% -----------------------------------------------------
Terrasson,
	et al.
present an energy model for Ultra-Low Power sensor nodes in \cite{terrasson_system_2014} [A Top-Down Approach for the Design of Low-Power Microsensor Nodes for Wireless Sensor Network].
In these papers,
	the authors described the modeling of a sensor node dedicated to wireless sensor network applications.
However,
	the RF module used in this study was the CC1100 module (a short range device) which did not include the LoRa technology.
An other energy estimation model is presented in [Energy Consumption Estimation of Wireless Sensor Networks in Greenhouse Crop Production],
	The goal of this work is to obtain a low power consumption of sensor nodes.

% -----------------------------------------------------
To save power,
	Mare S.
et al.
have concluded that the communication module and the microcontroller must be in idle state as long as possible when they are not active.
This work proposes interesting results,
	but LoRa and LoRaWAN technologies are not integrated into this study.

% -----------------------------------------------------
Phui,
	et al.
proposed a comparison of LoRaWAN classes and their power consumption in \cite{cheong_comparison_2017}.
The objective of this study is to offer an experimental comparison of LoRaWAN classes to verify the published current levels of different operating modes in LoRa datasheets.
The measurement results allow to estimate the lifetime of end-node devices.
However,
	in this paper,
	the authors did not study the effect of different LoRaWAN parameters such as coding rate,
	communication range and transmission power level on the total consumed energy.
Many other studies provide the power consumption of sensor nodes based on LoRa/LoRaWAN.
Most of the current values were obtained from the datasheet or by empirical means \cite{neumann_indoor_2016}[Design and implementation of the plug-play enabled ﬂexible modular wireless sensor and actuator network platform]LoRa Mobile-To-Base-Station Channel Characterization in the Antarctic],
	without developing an energy model that can estimate and optimize the energy consumption of the wireless sensors.

% -----------------------------------------------------
Casals,
	et al.
developed current models that allow the characterization of LoRaWAN devices lifetime and energy cost in \cite{casals_modeling_2017}.
The proposed models were very important and derived from measurement results using a currently prevalent LoRaWAN platform.

% -----------------------------------------------------
However,
	Casals,
	et al.
did not include the energy consumption of the processing and the sensor units.
In our paper,
	we have modeled these units for an application scenario of connected sensor.
Another major difference is that we have illustrated our energy model with optimization of LoRaWAN parameters such as the spreading factor SF,
	the coding rate CR,
	the bandwidth BW,
	the payload size and the communication range.
Optimizing these parameters is very important to reduce the energy consumption of the sensor node.
The previous works were proposed to estimate the amount of energy consumption by a sensor node.
Some of these studies have not included LoRa technology into their energy models,
	so they used different RF transceivers which are mainly dedicated to short range communication.
Other works did not study the energy optimization of sensor nodes.
In fact,
	optimizing LoRa and LoRaWAN parameters are very interesting to reduce the energy consumption by the communicating sensor.

\cite{chen_viable_2018}Z38EPLZL

Understanding the limitations of LoRa technology is critical to the design and management of LoRa networks.

% -----------------------------------------------------
Adelantado et al.
(2017) detailed the characteristics and limits of LoRa/LoRaWAN in terms of the relationships between duty cycle and throughput with various packet sizes.
Duty cycle defines the ratio of the time that a device can transmit data,
	in order to regulate signal transmission and avoid signal collisions.
They described how LoRa can be used in real-time monitoring,
	metering,
	smart transportation and logistics,
	but not for video surveillance.

% -----------------------------------------------------
As mentioned by Augustin et al.
(2016),
	the packet payload is up to 255 bytes with a low duty cycle limit.
Their study led to a number of open research challenges,
	particularly in channel management,
	such as time division multiple access over LoRaWAN and random-based access in unlicensed bands.
To design and improve LoRa network performance,
	understanding network-related dependencies is essential.

% -----------------------------------------------------
Bor and Roedig (2017) identified more than 6000 various parameter combinations for LoRa networks and developed an algorithm for automatic selection on LoRa transmission parameters.
The performance measurements on our LoRa network also were related to some of their parameter selections.
Augustin et al.(2016) also studied network-related parameters for performance improvements and also measured network sensitivity and coverage.
Our study proposed an appropriate strategy on gateway placement based on signal intensity and sensitivity in the context of three building density environments in Brisbane,
	Australia.

% -----------------------------------------------------
Elkhodr et al.(2016) reviewed various IoT communication technologies,
	including ZigBee, 6LoWPAN,
	Bluetooth Low Energy,
	LoRa and Wi-Fi.
The capabilities and behaviours of these technologies were analyzed.

% -----------------------------------------------------
Khutsoane et al.
(2017) surveyed a number of various LoRa technologies applications and contended that LoRa was ideal for low-power,
	long-range communications where low data rates were acceptable.
However,
	there had not been a common,
	comprehensive or holistic strategy for IoT network design,
	development and management from Elkhordr et al.
and Khutsoane et al.

% -----------------------------------------------------
Petrić et al.
(2016) deployed a LoRa experiment using an Arduino module and a Froggy Factory LoRa shield in the city of Rennes with their key focus on the quality of service.
They measured traffic between the gateway and the end devices.
The traffic generated was like that of a sensor monitoring network.
They focused on an observation of the performance metrics,
	not on overall LoRa design and deployment.

% -----------------------------------------------------
Our study fills this gap by proposing \cite{chen_viable_2018},
	particularly,
	using practical measurements of LoRa network dependencies and performance metrics to support our proposal.

% -----------------------------------------------------
Memos et al.
(2017) focused on the security and privacy issues on IoT network and proposed a security scheme to protect routing in IoT networks.
Their study contribution is on a design of an algorithm for surveillance systems used in Smart Cities.
Mesh networks may increase the coverage areas;
	however,
	forwarding traffic to other devices through multi-hop communications increases transmission latency and routing traffic,
	as stated by Filho et al.
(2016).
Our study focused on LoRa networks which are based on a star topology with single-hop communication and no routing complexity.
In particular,
	security complication is also alleviated and it has better throughput compared to mesh networks.

% -----------------------------------------------------
Centenaro et al.
(2016) stated that LoRa is a viable solution for the deployment of a Smart City and tested LoRa coverage based on one of modulation parameters and then proposed a LoRa system architecture based on the number in a particular urban population in Italy.
Our proposed architecture considered practical network coverage and signal attenuation in various building density environments.

\cite{dawaliby_adaptive_2019} WQ72KWJM

Performance evaluation over LoRa networks has been intensively reviewed by many research studies in the literature \cite{wixted_evaluation_2016} \cite{li_application_2017} [Experimental performance evaluation of lorawan:
	A case study in bangkok].
Other research studies focused on evaluating LoRa scalability \cite{mikhaylov_lorawan_2017} while considering co-SF interference that comes from collisions when using the same SF configuration on the same channel \cite{georgiou_low_2017} whereas others assumed that SFs on a channel are perfectly orthogonal \cite{bor_lora_2016} \cite{bor_lora_nodate}.
SF represents the ratio between the chirp rate and the data symbol rate and affects directly the data rate and the range that a LoRa device can reach away from a LoRaWAN gateway.
Moreover,
	co-SF directly impact communication reliability,
	reduces the packet delivery ratio (PDR) successfully decoded at the gateway \cite{piva_impact_2017} and limits the scalability of a LoRa network when increasing the number of devices [Lora throughput analysis with imperfect spreading factor orthogonality].
Therefore,
	the latter should be considered in any upcoming study related to SF configuration strategies and network deployments.
Some study examples focused on finding the optimal transmitter parameter settings that satisfy performance requirements using a developed link probing regime \cite{bor_lora_2017}.

% -----------------------------------------------------
In \cite{lim_spreading_2018},
	the authors analyze several SF configuration strategies where a group of LoRa devices can be configured with similar or heterogeneous SFs based on their position from the gateway.
The goal is to find the scheme that gives the best performance in terms of PDR.
However,
	the impact of the latter configuration on network slicing has not been previously tested.
Few research works recently tackled network slicing in IoT and focused on machine critical communications over various wireless networks.

% -----------------------------------------------------
The work in \cite{nakao_end--end_2017} introduced a slicing infrastructure for 5G mobile networking and summarized research efforts to enable end-to-end network slicing between 5G use cases.

% -----------------------------------------------------
Furthermore,
	authors in \cite{gadallah_dynamic_2017} and \cite{rezende_adaptive_2018-1} adopted network slicing in LTE mobile wireless networks.
The former proposed a dynamic resource reservation for machine-to-machine (M2M) communications whereas the latter present a slice optimizer component with a common objective in both papers to improve QoS in terms of delay and link reliability.
In a 5G wearable network,
	the authors took advantage of slicing technology to enhance the network resource sharing and energy-efficient utilization \cite{hao_network_2018}.
Moreover in [Joint application admission control and network slicing in virtual sensor networks],
	the authors perform slicing in virtual wireless sensor networks to improve lease management of physical resources with multiple concurrent application providers.
In [Network slicing for ultra-reliable low latency communication in industry 4.0 scenarios],
	authors focused on URLLC and proposed several slicing methods for URLLC scenarios which require strong latency and reliability guarantees.
Nowadays,
	guaranteeing service requirements in LoRa wireless access network (LoRaWAN) with traffic slicing remain as open research issues \cite{adelantado_understanding_2017}.
Therefore,
	unlike the previous work,
	in this article network slicing is investigated in LoRa technology which,
	to the best of our knowledge,
	has not been treated before by the research community.

\cite{feltrin_lorawan_2018} EUXH6LEM

The scientific literature on LoRa,
	and LPWANs in general,
	is slowly expanding but most of the papers are still related to the link-level evaluation of the technology.
Tests using Sigfox,
	LoRaWAN,
	and pre-standard NB-IoT solutions,
	have been made on the field by several network operators.
Some field trials have been carried out,
	to determine LoRa ranging performance,
	in free space conditions \cite{aref_free_2014-1} and in more complex scenarios \cite{petajajarvi_coverage_2015}.

% -----------------------------------------------------
Different studies have investigated the use of LoRa technology in specific fields of application,
	as for example,
	sailing monitoring systems \cite{li_application_2017},
	tactical troops tracking systems \cite{san-um_long-range_2017},
	smart cities \cite{stan_overview_2016},
	etc.
In contrast with these works,
	we address a large set of applications,
	properly categorizing them.
Many details regarding the LoRa modulation and physical layer have been recently published in [revspace.nl/DecodingLora ] and [Decoding LoRa:
	Realizing a modern LPWAN with SDR],
	where the Authors studied the output signal generated by commercial transceivers to understand how information is encoded and embedded in the chirp waveforms.

% -----------------------------------------------------
The interference problem has been addressed in \cite{bor_lora_nodate},
	where the Authors study packet collisions applying a time offset between each other;
	in \cite{georgiou_low_2017} and \cite{goursaud_dedicated_2015} the orthogonality of transmissions performed with different Spreading Factors,
	an important issue discussed in more detail in Section V,
	is studied mathematically.
More precisely,
	in these articles the Authors analyze the architecture of the LoRa (de)modulator and determine the conditions for a capture to happen in the presence of two signals with different SF.
We performed a similar analysis,
	but using an experimental approach.

% -----------------------------------------------------
The first papers about the system-level LoRa network capacity have been published very recently,
	most of them addressing the problem through simple mathematical approaches \cite{mikhaylov_analysis_2016},
	\cite{adelantado_understanding_2017}.
In these works the limitations imposed by regulation on the utilization of the channel are taken into consideration as a major limit for the network capacity;
	although this is true when few continuously transmitting devices are considered,
	if the traffic generated is more sporadic and the number of devices is higher,
	this does not represent a problem.
It is possible to show that among the use cases that we consider in this paper the channel utilization for a single device is always below 0.55\%.

% -----------------------------------------------------
Moreover,
	with respect to \cite{mikhaylov_analysis_2016} and \cite{adelantado_understanding_2017},
	we determine

the capacity of a network considering the full LoRa protocol stack,
	the presence of concurrent transmissions and consequent collisions or captures,
	and realistic information on the physical layer obtained through experiments.

% -----------------------------------------------------
In \cite{bor_lora_2016} the Authors estimated,
	through simulations,
	the capacity of a LoRa network assuming a simpler collision mechanism and protocol than what we used in this work;
	these assumptions lead to a lower capacity with respect to what we present in this paper.
In \cite{wixted_evaluation_2016} the Authors studied experimentally the impact on the coverage of having multiple gateways deployed in a particular area of Glasgow.
Our work,
	though,
	focuses more on capacity than on coverage:
	a fact of relevance for LoRa,
	whose receive sensitivity depends on transmission parameters (the Data Rate).

\cite{sanchez-iborra_performance_2018} ZD2JYZZS


% -----------------------------------------------------
Although the appearance and widespread of LoRaWAN are recent,
	a number of works have been published aiming at analyzing or evaluating its performance in different scenarios or proposing enhancements to the off-the-shelf version of LoRaWAN \cite{herrera-tapia_evaluating_2017}.
From a theoretical perspective,
	works in \cite{georgiou_low_2017}\cite{mikhaylov_analysis_2016}\cite{bankov_limits_2016} analyzed the capacity of LoRaWAN in terms of scalability and node-throughput.
All these works concluded that LoRaWAN systems should be carefully configured and dimensioned with the aim of hosting a great number of end-devices.
Concretely,
	in \cite{georgiou_low_2017},
	the negative impact of interferences within highly-populated LoRaWAN cells was studied.
Authors found some issues related to the co-spreading sequence interference,
	which notably harms the scalability of LoRaWAN systems.

% -----------------------------------------------------
However,
	as stated in \cite{mikhaylov_analysis_2016},
	LoRaWAN networks can be generally utilized for fairly dense deployments with relaxed latency or reliability requirements.
Thus,
	in order to ensure the network scalability when the end-device population prominently grows,
	two measures can be taken:
	(i) the number of delivered packets per node per day should be reduced;
	or (ii) the number of gateways should be increased \cite{bankov_limits_2016}.
As mentioned above,
	some works have proposed enhancements to the original LoRaWAN features \cite{naoui_enhancing_2016}\cite{weber_ipv6_2016}.

% -----------------------------------------------------
In \cite{naoui_enhancing_2016},
	authors presented a solution to improve the overall security of a LoRaWAN-based IoT system.
This proposal employed proxy-nodes for performing the cryptographic operations in order to avoid heavy computation in the constrained end-nodes.

% -----------------------------------------------------
In turn,
	work in \cite{weber_ipv6_2016} presented an integration of IPv6 into LoRaWAN.
Similar to the case of 6LoWPAN,
	this solution permitted a higher interoperability of the IoT network with the outside world.
Although interesting,
	both works lacked of a detailed performance evaluation to demonstrate the impact of their proposals on the system operation.
From a different perspective,
	other studies presented the results extracted from experimental tests conducted in diverse scenarios and situations [next citation].
These works focused on evaluating the performance of LoRaWAN under different propagation and environmental conditions.

% -----------------------------------------------------
For example,
	in \cite{petric_measurements_2016-1},
	a real LoRaWAN deployment was evaluated and it was found that the base-station antenna location and elevation have great importance in the network performance.
The measurements were carried out using three different base-stations.
A similar experimental study was elaborated in A Study of LoRa:
	Long Range \& Low Power Networks for the Internet of Things.
In this case,
	authors focused on tuning the LoRaWAN PHY layer,
	i.e.,
	LoRa,
	configuration parameters,
	identifying both Spreading Factor (SF),
	which will be explained later in detail,
	and data-rate as the principal factors impacting on the network coverage.

% -----------------------------------------------------
Another coverage study focused on LoRa,
	was presented in \cite{haxhibeqiri_lora_2017},
	but,
	in this case it was carried out in an indoor scenario.
The presented outcomes demonstrated the robustness of LoRa in adverse industrial environments,
	even with high data-rates.

% -----------------------------------------------------
In turn,
	authors of \cite{petajajarvi_coverage_2015} investigated the coverage of LoRaWAN in different environments by placing the end-device onboard a car and a boat.
Interesting coverage ranges over 10 km were reached with a not excessive Packet Loss Rate (PLR).
A more elaborated work was developed in \cite{petajajarvi_performance_2017},
	in which the same authors extended their measurements and evaluated the performance of the system under mobility conditions.

% -----------------------------------------------------
From a simulation perspective,
	the work in \cite{herrera-tapia_evaluating_2017} focused on vehicular scenarios and examined the performance of LoRaWAN in vehicular opportunistic networks,
	showing better results in comparison with WiFi technology.
As observed in the reviewed works,
	the coverage range and the performance of different LoRaWAN configurations were evaluated.
However,
	these studies did not characterize the sampling points depending on their adversity against wireless transmissions.
In this work,
	we evaluate the performance of LoRaWAN under three well-defined conditions,
	namely,
	urban,
	suburban,
	and rural scenarios.
By using this methodology,
	we identify the most proper configuration for LoRaWAN PHY layer parameters in order to reach the best performance in each type of scenario.

% -----------------------------------------------------
Besides,
	a comparison of the attained experimental results with a theoretical propagation model is also presented.
A similar approximation was considered in \cite{petajajarvi_coverage_2015} but,
	in this work,
	the attained coverage range was compared with the predictions given by the simple Free-Space model.
This model is known to be inadequate to predict path loss in complex scenarios like those with the presence of obstacles.
For that reason,
	in the present work,
	we make use of the predictions provided by a network-planning tool employing the widely used Okumura–Hata propagation model over realistic topographic maps.

\cite{casals_modeling_2017} H6QDESI3

Most of the research done on LoRa/LoRaWAN has focused on features such as coverage,
	robustness,
	capacity,
	scalability,
	delay and throughput \cite{mikhaylov_analysis_2016}
 \cite{petajajarvi_coverage_2015}
\cite{adelantado_understanding_2017}
\cite{augustin_study_2016}
\cite{nolan_evaluation_2016}
\cite{petajajarvi_performance_2017}
\cite{mikhaylov_lorawan_2017}
\cite{jetmir_haxhibeqiri_lora_2017}
\cite{petajajarvi_evaluation_2017}
However,
	a characteristic such as energy consumption,
	which is crucial considering that many LoRa/LoRaWAN devices will not be grid-powered,
	has received limited attention.
We next review the literature on LoRaWAN energy consumption.
We first focus on current consumption details of LoRa/LoRaWAN devices reported in published works,
	and secondly we discuss the few existing models of LoRa/LoRaWAN energy consumption,
	node lifetime or energy cost of data delivery.
Several works provide current consumption data of LoRa/LoRaWAN devices,
	obtained from a datasheet or by empirical means  \cite{petajajarvi_evaluation_2017}
\cite{kim_cooperative_2017}
\cite{mahmoud_study_2016}
[LAMBS: Light and Motion Based Safety] \cite{bor_lora_2017}
[omparación de Soluciones Basadas en LPWAN e IEEE 802.15.4 Para Aplicaciones de Salud Móvil (“m-Health”)] \cite{neumann_indoor_2016}
[Design and implementation of the plug\&play enabled ﬂexible modular wireless sensor and actuator network platform] \cite{magno_wulora_2017}
\cite{dongare_openchirp_2017}
\cite{conus_event-driven_2016}
Such details,
	which are summarized in Table 1,
	correspond to sleep,
	transmission and reception device states.
As it can be seen,
	sleep current ranges from 7.66 μA to 34 mA (or between 30.9 μA and 3.4 mA excluding LoRa-only and custom devices).
Sleep current for the considered hardware platforms is up to several orders of magnitude greater than that of their transceivers (see Table 2),
	which can be near or even lower than 1 μA.
One important conclusion is that current LoRa/LoRaWAN nodes are far from the degree of optimization exhibited by platforms that use other low power technologies.
For example,
	IEEE 802.15.4 and Bluetooth Low Energy (BLE) commercial devices feature a sleep current near 1 μA [AN079-Measuring Power Consumption of CC2530 with Z-Stack]\cite{aguilar_opportunistic_2017}.
Therefore,
	in order to achieve attractive node lifetime figures (e.g.,
	in the order of years),
	current LoRaWAN nodes need batteries with greater capacity than typical button cell batteries,
	e.g.,
	of AA type,
	which however have bigger size and are more expensive.
We attribute the sleep current in LoRaWAN devices to suboptimal hardware integration of device components,
	e.g.,
	the microcontroller and the transceiver.
Based on the characterization of sleep,
	transmit and receive states of a LoRa/LoRaWAN device,
	a few analytical models of LoRa/LoRaWAN energy consumption,
	node lifetime or energy cost of data delivery have been published  \cite{kim_cooperative_2017}
\cite{conus_event-driven_2016}
\cite{sartori_smart_2016}
\cite{toussaint_performance_2016}.
However,
	these models are too simple,
	since there exist several other states for a LoRa/LoRaWAN device involved in a communication that need to be considered (see Section 4).
Next,
	we briefly present the main results and other limitations of these works.
An accurate calculation of message transmission time is only provided in \cite{sartori_smart_2016},
	however the study only focuses on LoRa,
	and therefore it does not model the MAC layer mechanisms defined in LoRaWAN,
	such as use of acknowledgments,
	receive windows,
	and retransmissions (see Section 3).

% -----------------------------------------------------
In \cite{kim_cooperative_2017},
	which focuses only on optimizing downlink communications,
	fixed LoRaWAN settings (i.e.,
	a single DR and acknowledged transmission) are considered.
Energy consumption of 0.05–0.44 mJ and a battery lifetime between 13 and 1 year,
	respectively,
	are obtained for a device running on two AA batteries,
	when transferring data from 1 to 10 times per hour.
However,
	one of the most important values used in the model,
	the sleep current (of 2 μA),
	is without explanation significantly lower than the corresponding value in the datasheet published by the manufacturer (i.e., 30.9 μA).

% -----------------------------------------------------
In \cite{toussaint_performance_2016},
	only the energy related to the activation of a LoRaWAN node by using the On-The-Air Activation (OTAA) mode is modeled.

% -----------------------------------------------------
In \cite{conus_event-driven_2016},
	the battery capacity consumed during a day by a device is calculated assuming 100 events detected and 10 frame transmissions performed by the device.
The result is 222.66 μAh,
	which corresponds to a lifetime of 21.5 months for a 150 mAh button cell battery.
Neither the impact of using acknowledgments,
	nor the influence of the DR configured are considered.
Finally,
	the impact of errors due to corruption on LoRaWAN energy performance has not been modeled in publicly available works.

\cite{barro_lorawan_nodate} LRLSSXZL


% -----------------------------------------------------
A first study \cite{barro_tltn_2019} was conducted on stand-alone LoRaWAN base stations that can operate even when Internet is intermittent or non-existent and that have the ability to communicate with each other \cite{barro_smart_2019},
	in order to form a city size extensive network.
In this paper,
	we will first look at the indexes as well as at the practitioners,
	to find the existing tools or to make one,
	in order to ensure a good coverage study based on this concept and,
	then,
	to propose a testBed for this purpose.
Noted that \cite{barro_tltn_2019} and \cite{barro_smart_2019} are steps of \cite{barro_towards_2018} that aims to study the feasibility of the smart city in developing countries,
	especially in Africa.
However,
	saying that Internet is not accessible or is intermittent is only a general observation,
	so some people can claim to have acceptable connectivity \cite{barro_smart_2019} (with a round-trip time less than 100 ms (see Fig.1)) and therefore,
	will want to go in this direction.
This is why it should be wise and judicious to propose an architectural model offering several options of communication on demand and which will remain flexible to future evolutions.
This is how we thought to add the Wi-Fi protocol (which is part of the broad family of radio technologies and used for equipment implementing the IEEE 802.11x standard family) to the proposed model in \cite{barro_smart_2019} as it is able to achieve these goals.
Indeed,
	it belongs to the Wi-Fi Alliance organization [Wi-Fi Alliance] and operates in the frequency band 2.5 GHz (for 802.11b, 802.11g or 802.11n) or 5 GHz for the 802.11a.
We are also seeing continuous improvement of its technologies (see Table 1).
Strictly speaking,
	we all know that sending naked data

\cite{blaszczyszyn_analyzing_2019} QTLET7Q6

% -----------------------------------------------------
A few papers,
	such as \cite{petric_measurements_2016},
	present measurements of existing LoRa systems and study the actual performance of the end devices with respect to their relative distance to the gateways.
They aim at optimising the parametrization of LoRa networks.
However,
	due to the limited number of end devices considered in these studies,
	it is difficult to gauge the scaling properties of LoRa networks,
	for instance in terms of the maximum number of end devices supported with a given goodput rate.
Moreover,
	these studies do not permit a fine-tuned analysis of collisions in LoRa networks.

% -----------------------------------------------------
In contrast,
	\cite{jetmir_haxhibeqiri_lora_2017} scrutinizes interference in LoRa in order to establish packet collision rules,
	which are reproduced next in a simulation model allowing the authors to study the scalability issues of LoRa networks.
A real platform to test capture in LoRa networks is used in \cite{bor_lora_2016}.
The conclusions drawn from the tests lead to a collision model close to that derived in \cite{jetmir_haxhibeqiri_lora_2017} and to similar scalability evaluation results.
We recall the collision rules established in \cite{jetmir_haxhibeqiri_lora_2017} and \cite{bor_lora_2016} in Section 3.2 since we integrate them in our stochastic-geometric LoRa network model.

\cite{piva_impact_2017} D35WN7JM

Since LoRa is quite a recent technology,
	relatively few works have already been published on its performance.

% -----------------------------------------------------
Specifically,
	\cite{atanasovski_long-range_2015}focus on LoRa applications and PHY,
	while in \cite{augustin_study_2016} some test-bed and simulation results are presented but with a low number of devices.

% -----------------------------------------------------
In \cite{bankov_limits_2016} authors model LoRaWAN performance analytically in a scenario with high number of devices and propose solutions to improve its performance.
Most of the current studies are based on simulation results.
Authors in \cite{bor_lora_2016} implemented and used the LoRaSim simulator [www.lancaster.ac.uk/scc/sites/lora] to investigate the capacity limits of LoRa networks.
They showed that a typical deployment can support only 120 nodes per 3.8 ha,
	although performance can be improved with multiple gateways.

% -----------------------------------------------------
The paper in \cite{reynders_range_2016} compared the performance of LoRa and ultra narrowband (Sigfox-like) networks,
	showing that ultra narrowband has a larger coverage but LoRa networks are less sensitive to interference.
Finally,
	authors in [Decoding LoRa:
	realizing a modern LPWAN with SDR] presented details on the patented LoRa PHY and introduced gr-lora,
	an open source SDR-based implementation of LoRa PHY.
All of these works,
	however,
	assume that the SFs adopted by LoRa are perfectly orthogonal,
	thus simplifying the analysis and consequently the network capacity.
Instead,
	in this paper we show that,
	due to the imperfect orthogonality of the SFs,
	inter-SF collisions can prevent the correct reception of the transmissions with serious impact on LoRa performances.
To the best of our knowledge,
	we are the first to demonstrate and quantify this performance degradation.

\cite{dix-matthews_lora_2018} 9AZ7VKCG

Since LoRa has so many transmission parameters to confgure,
	the crucial task of fnding a parameter combination to balance packet delivery performance and energy consumption can be difcult.
The pTunes framework is a general modelling framework for selecting optimal MAC parameters based on measurements \cite{zimmerling_ptunes_2012}.
We propose a similar approach for selecting LoRa parameters.
Several

studies have studied the capability of LoRa technology measuring performance for diferent parameter settings in indoor 

\cite{bor_lora_2017}
\cite{bor_lora_2016}
\cite{hutchison_data-aware_2013}
\cite{cardell-oliver_error_2012}
\cite{marco_cattani_experimental_2017}
[LoRa from the city to the mountains:
	Exploration of hardware and environmental factors] [LoRaWANTM Specification] \cite{marcelis_dare_2017}
\cite{petajajarvi_coverage_2015}
\cite{petajajarvi_evaluation_2017}

or outdoor \cite{augustin_study_2016}[LoRa from the city to the mountains:
	Exploration of hardware and environmental factors]\cite{marcelis_dare_2017} settings.

% -----------------------------------------------------
Bor and Roedig propose an algorithm for fnding the best transmission setting for a specifc transmission channel \cite{bor_lora_2017}.
It performs a type of binary search of the parameter space,
	testing each setting for its packet reception rate until a good setting is found.
The aim is to balance the cost of fnding good parameters against the packet delivery rate achieved.
The ground truth for optimal settings are determined from a large look up table of receive probabilities based on in situ experiments with all combinations of the transmission parameters.

% -----------------------------------------------------
Cattani considered optimal parameter settings by measuring the packet reception rate and energy efciency for three types of channel (indoor,
	outdoor and underground) under diferent LoRa parameter settings \cite{marco_cattani_experimental_2017}.
An interesting fnding was that it was not worth tuning LoRa parameters to reduce the data rate in order to maximise the probability of successful reception.
Instead lower energy settings which have a high data rate are preferred.
They also considered the efect of environmental parameters on channel performance and found that high temperature at the node reduced packet delivery rate signifcantly.
LoRaWAN is a mesh protocol for LoRa nodes.
It specifes message scheduling and supports an Adaptive Data Rate (ADR) protocol for adjusting LoRa transmission parameters [LoRaWANTM Specification].
Our paper uses LoRa physical layer without the LoRaWAN protocols,
	but some results from LoRaWAN papers also apply in our case.
LoRaWAN nodes start with a default parameter setting and then after reception of some messages the receiver can instruct a transmitter node to step up or down its spreading factor or transmission power.
ADR uses 8 data rate settings and 6 transmission energy settings selected for a balance between packet delivery success and energy saving.

% -----------------------------------------------------
Marcelis et al.
measured the spatial and temporal properties of LoRaWAN channels using both static and mobile transmitters \cite{marcelis_dare_2017}.
They found that channels at the limits of the transmission range (7.5km) had very low packet reception rates.
An efcient coding scheme based on convolutional codes and fountain codes was proposed for data recovery.
Their experiments show that with this protocol 99\% of the data can be recovered and that,
for 10 byte packets,
	it has 21\% more data recovery and 42\% lower energy
consumption than a naive repetition coding protocol.
Research Gaps.
Developing a generalised methodology for determining the best parameter values to use for very low power LoRa applications remains an open research question.
Another open question is what is the best strategy for achieving high data delivery rate with low energy use.
It has been shown that high data delivery rates can be achieved without over-engineering a setting to achieve the highest packet reception rate \cite{marco_cattani_experimental_2017}\cite{marcelis_dare_2017}.
This paper develops this line of thinking and demonstrates that the LoRa physical layer with data-aware repetition coding is an efective solution for achieving reliable and very low energy LoRa-based sensor networks.

\cite{farooq_search_2018} ZC5I8BLQ

LoRa is a physical layer radio modulation technique based on chirp spread spectrum (CSS).
The goal is to enable low throughput communication across long distances with low power consumption.
LoRa features include long range,
	multipath resistance,
	robustness,
	low power consumption,
	forward error correction (FEC),
	and Doppler resistance.
LoRa provides several physical layer parameters that can be customized.
These parameters include spreading factor (SF),
	bandwidth (BW),
	transmission power (TP),
	and code rate (CR).
These parameters affect the available bit rate,
	resilience against interference,
	and ease of decoding.
LoRa uses seven different SFs,
	namely:
	[SF 6 ,
	SF 7 ,
	SF 8 ,
	SF 9 ,
	SF 10 ,
	SF 11 ,
	SF 12].
In LoRa a transceiver can select a BW in the range [-7.8, 500] kHz.
However,
	LoRa transceivers typically operate at 125 KHz, 250 KHz,
	or 500 KHz.
LoRa defines four different coding rates, 45 , 46 , 47 ,
	and 48 .
Higher CR implies higher protection against burst interference,
	and vice versa.
LoRaWAN [LoRaWAN Speciﬁcations] is a MAC layer protocol and network architecture designed to be used with the LoRa physical layer.
LoRaWAN uses pure Aloha

(PA) as a channel access protocol.
A LoRaWAN gateway can decode eight simultaneous transmissions based on different combinations of SFs and BWs,
	however at any given time a node in a LoRaWAN network uses particular combination of SF,
	BW,
	TP,
	and CR.


% -----------------------------------------------------
LoRa throughput is analyzed in \cite{adelantado_understanding_2017},
	\cite{bor_lora_2016},
	\cite{jetmir_haxhibeqiri_lora_2017},
	and \cite{mikhaylov_analysis_2016},
	which have primarily focused on Class A LoRaWAN devices.
It has been shown that although LoRaWAN uses PA channel access control protocol,
	due to LoRa’s robust modulation technique an increase of up to 1000 nodes per gateway results in only 32\% more packet losses,
whereas for the same scenario the losses are up to 90\% in other PA-based networks \cite{jetmir_haxhibeqiri_lora_2017}.
As LoRa allows customization of transmission parameters,
	therefore recently some research efforts focused on devising algorithms for effective LoRa’s transmission parameter selection by considering a specific goal.

% -----------------------------------------------------
For example,
	in \cite{bor_lora_2017},
	a transmission parameter selection algorithm for LoRa is presented with a goal to minimize energy consumption at a specific reliability level.
To enable LoRaWAN to achieve a high data rate two different spreading factor allocations algorithms are presented in \cite{cuomo_explora_2017}.

% -----------------------------------------------------
Similarly,
	in \cite{reynders_power_2017} power and spreading factor control algorithm is presented to achieve fairness in LoRa-based networks.
Existing research work on LoRa has largely ignored the investigation of different channel access control protocols to improve the performance of LoRa in terms of reliability,
	throughput,
	and energy consumption.
Therefore,
	here we focus on investigating the impact of a range of channel access control protocols on a LoRa-based network.

\cite{gupta_battery_2019} D6JC9B4S

As LoRa is considerably new technology,
	only limited work has been done in the area of battery optimization.

% -----------------------------------------------------
In [Lorawan speciﬁcation] and \cite{hauser_proposal_2017},
	adaptive data rate (ADR) method is specified for energy optimization in static nodes.
ADR involves adaptation of LoRa transmission parameters to save transmission energy using feedback mechanism based on previous communications.
Similarly,
	a probing algorithm using trial and error method for selecting the optimal settings is illustrated in \cite{bor_lora_2017} These described methods converge to an optimal setting step by step after multiple transmissions for the fixed distance between the node and the gateways.
However,
	such methods become unsuitable in moving node scenarios.
The research involving LoRa moving nodes include several works.

% -----------------------------------------------------
LoRa is used for obtaining battery status in moving Electric Vehicles in [An efﬁcient electric vehicle charging architecture based on lora communication],
	tracking system for moving vehicles in [Design and implementation of object tracking system based on lora]–[Efﬁcient,
	real-time tracking of public transport,
	using lorawan and rf transceivers],
	[Long-range wireless sensor networks for geo-location tracking:
	Design and evaluation],
	and human monitoring in [We-safe:
	A wearable iot sensor node for safety applications via lora] and [The experimental trial of lora system for tracking and monitoring patient with mental disorder].
However,
	none of the aforementioned works account for energy optimization in transmission settings for moving nodes.
All of them use conventional method of using a fixed preconfigured setting for transmissions throughout the movement.
This conventional mechanism is highly energy inefficient as it uses high power settings even when the node is close to a gateway.
Besides,
	battery optimization techniques [Performance-aware energy optimization on mobile devices in cellular network],
	[etime:Energy-efﬁcient transmission between cloud and mobile devices] for moving nodes used in other wireless communications such as LTE,
	Wi-Fi, 5G,
	require frequent exchanges of information about channel conditions,
	previous communication history,
	user traffic,
	etc.
However,
	such methods become inapplicable for LoRa due to its duty-cycle restriction,
	in which each LoRa node is allowed to only send a few messages a day to avoid interference.

\cite{hauser_proposal_2017} CNASAVPC

Wireless transmission parameters in the unlicensed spectra are regulated regionally with occasional additions by countrylevel regulators.
Regulations typically include,
	but are not limited to,
	definition of maximal effective radiated power (ERP) and duty-cycle,
	and medium access methods.

% -----------------------------------------------------
As reported by Petajajarvi,
	Mikhaylov,
	Roivainen,
	et al.
\cite{petajajarvi_coverage_2015},
	the performance of the LoRa ® modulation is satisfactory in real-life environment experiments even under relatively strict European regulations [ERC Recommendation 70-03 relating to the use of Short Range Devices,
	p. 7,
	band h1.4].
Although multiple simultaneously emitted LoRa ® transmissions can be processed by a single gateway exploiting the orthogonality of the spreading factors in addition to using multiple transmission sub-bands,
	the nature of the ALOHAbased access to the medium inevitably leads to the presence of transmission collisions.

% -----------------------------------------------------
As confirmed by Georgiou and Raza \cite{georgiou_low_2017},
	the exponential dependence of the TOA on SF introduces exponential upper bound on the network performance.

% -----------------------------------------------------
As Adelantado,
	Vilajosana,
	Tuset-Peiró,
	et al.
state \cite{adelantado_understanding_2017},
	the throughput of the network is upper-bound either by the collision rate (lower DR,
	shorter TOA) or by the duty-cycle limitation (higher DR,
	longer TOA).
The systems containing end-nodes whose transmission parameters are constant with respect to time are particularly affected.

% -----------------------------------------------------
As a partial solution,
	Bor,
	Roedig,
	Voigt,
	et al.
suggest \cite{bor_lora_2016} implementing a dynamic transmission scheme,
	i.e.
ADR in LoRaWANTM,
	and to densify the infrastructure by adding additional gateways.
Since as seen by the network operators,
	the implementation of an ADR is a CAPEX-efficient way to optimize the capacity of the networks,
	vendors offering NM on the market keep their algorithms as a part of the intellectual property.
Contrary to this trend,
	the general customer availability of LoRaWANTM products catalyzed the creation of several open source NM implementation projects which include the globally recognized The Things Network (TTN) and a younger LoRa Server whose ADR algorithms are publicly available [thethingsnetwork.org/wiki/LoRaWAN/ADR].
In this paper,
	their algorithm was adapted and further improved as part of the effort to support the community project.

\cite{hoeller_exploiting_2018} RJ28KVZT

The Internet-of-Things (IoT) is pushing a paradigm shift in the design of connectivity solutions for smart devices.
Nowadays,
	the community widely accepts that current connectivity solutions like WiFi,
	Bluetooth,
	and ZigBee alone cannot cope with the billions of devices expected to integrate the IoT in the forthcoming years [Long-range commun.
in unlicensed bands:
	the rising stars in the IoT and smart city scenarios].
The IoT is emerging as a solution to integrate different communication technologies,
	each focusing on the requirements of specific applications.
The so-called Massive IoT (mIoT) figures within this context as a network scenario with thousands of connected devices running noncritical,
	low-power,
	and low-cost applications tolerant to high latency and small data-rates [Cellular netw.for massive IoT enabling low power wide area appl].
New communication technology must address such peculiar scenario,
	and this is the case of Low-Power Wide-Area Network (LPWAN) technologies like LoRa WAN,
	S IG F OX ,
	NB-I O T,
	and RPMA [Understanding the IoT connectivity landscape:
	a contemporary M2M radio technology roadmap].
This paper concerns the assessment of the uplink channel of the LoRa (Long-Range) technology,
	which forms the physical layer (PHY) of the LoRa WAN protocol stack [lora-alliance.org].
Although LoRa is in fast-paced adoption,
	reports on deployments with large numbers of stations are yet to come out,
	making their performance and capacity models still an open problem.
Recent related work has sought to assess the performance of LoRa networks using both analytic modelings [Do LoRa low-power wide-area netw.
scale?]–\cite{georgiou_low_2017}\cite{pop_does_2017} and real measurements  [Performance of a low-power wide-area netw.
based on LoRa technol.:
	Doppler robustness,
	scalability,
	and coverage] \cite{wang_performance_2017}
\cite{neumann_indoor_2016}
\cite{angrisani_lora_2017}
\cite{jorke_urban_2017}
[Long range commun.
in urban and rural environ].
Analytic models have been proposed for a variety of scenarios and communication phenomena.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} experimentally observed the capture effect of LoRa and modeled the capacity of such networks,
	concluding that LoRa networks with one gateway and conservative operational parameters do not scale well,
	while networks with dynamic adaptation of operating parameters or multiple gateways scale better.

% -----------------------------------------------------
Georgiou and Raza \cite{georgiou_low_2017} propose an analytic model for LoRa coverage probability that takes into account Rayleigh fading,
	showing that LoRa networks are sensitive to network usage.

% -----------------------------------------------------
Pop et al.
\cite{pop_does_2017} evaluated the impact of the LoRa WAN downlink on the uplink goodput and coverage probability.
They verified that the downlink becomes unable to deliver several acknowledgment packets if too many end-devices request delivery confirmation.

% -----------------------------------------------------
Concerning the modeling of communication fading,
	only Georgiou and Raza \cite{georgiou_low_2017} and Pop et al.
\cite{pop_does_2017} take this impairment into account.
Several works have used measurements to evaluate the performance of LoRa networks.

% -----------------------------------------------------
Petäjäjärvi et al.
[Performance of a low-power wide-area netw.
based on LoRa technol.:
	Doppler robustness,
	scalability,
	and coverage] analyze Doppler robustness,
	scalability,
	and coverage of LoRa networks and report the experimental validation of such metrics in terrestrial and water environments for static and mobile nodes.

% -----------------------------------------------------
There are similar measurement reports in other environments,
	including a university campus \cite{wang_performance_2017},
	indoor applications \cite{neumann_indoor_2016},
	industry \cite{angrisani_lora_2017},
	dense cities downtown \cite{jorke_urban_2017},
	and rural areas [Long range commun.
in urban and rural environ].
These measurements show interesting results,
	however,
	none of them used a large numbers of nodes and,
	thus,
	it is impossible to use the results to validate dense network models.
As reports on the performance of LoRa and other LPWAN started to reveal the limitations of such networks,
	a few techniques were proposed to enhance the performance of LoRa [EXPLoRa:
	Extending the perf.
of lora by suitable spreading factor allocations]\cite{bor_lora_2017}[Resource efﬁc.
in low-power wide-area netw.
for IoT appl] and other LPWAN technologies [Optimization of the predeﬁned number of replications in a UNB-based IoT netw][Eval.
of macro diversity gain in long range ALOHA netw][Performance eval.
of LoRa netw.
in a smart city scenario].

% -----------------------------------------------------
Cuomo et al.
[EXPLoRa:
	Extending the perf.
of lora by suitable spreading factor allocations] suggest algorithms to replace LoRa WAN adaptive data rate strategy.
The algorithms do not base the spreading factor (SF) configuration only on distance and received power,
	but also take into account the number of connected devices,
	equalizing the time-on-air (ToA) of packets in each SF.

% -----------------------------------------------------
Bor and Roedig \cite{bor_lora_2017} explore LoRa configuration

\cite{marais_lora_2017} 3B3UUVC9

Some of the LPWAN offerings are mainly proprietary but the LoRa Alliance develops LoRaWAN as an open standard.
The physical layer (LoRa) was however developed by Semtech which remain the sole LoRa integrated circuit producer \cite{bankov_limits_2016}.
LoRaWAN is the communication protocol (ALOHA-based) [A technical overview of LoRa and LoRaWAN] and system architecture for a network using the LoRa physical layer \cite{wixted_evaluation_2016}.
LoRaWAN is not the only communication protocol that uses LoRa as the physical layer:
	Symphony Link TM and LoRaBlink are other examples.
LoRaBlink \cite{bor_lora_nodate} adds multi-hop support while Symphony Link offers guaranteed Acknowledgements (ACKs),
	over the air firmware updates and many other features.
The DASH7 stack can also be configured to use LoRa as its physical layer and can potentially run side-by-side with a LoRaWAN stack [DASH7 Speciﬁcation-DRAFT 16-An Advanced Communication System for Wide-Area Low Power Wireless Applications and Active RFID].
A.
Physical layer (LoRa) LoRa is a derivative of Chirp Spread Spectrum (CSS) modulation with integrated Forward Error Correction (FEC) \cite{reynders_chirp_2016}.
LoRa uses sub one GHz ISM bands in Europe and North America and its wide band nature allows LoRa to better compensate for a low Signal to Noise Ratio (SNR) [LoRa Modulation Basics,].
This allows LoRa to demodulate signals even when they are 19.5 dB below the noise floor \cite{bor_lora_2016}.
CSS allows for a longer communication range than Frequency-Shift Keying (FSK) without an increase in power consumption [A technical overview of LoRa and LoRaWAN].

Transmitting at higher power levels will increase a LoRa node’s range.
Nodes can adjust their output power to meet regulatory requirements.
In Europe +14 dBm is the maximum transmit power except in the G3 band (+27 dBm) [A technical overview of LoRa and LoRaWAN].
LoRaWANs deployed in Europe have channel bandwidths of either 125 kHz or 250 kHz and a single FSK transmission channel providing a higher data rate is also available \cite{wixted_evaluation_2016}.
Data rates are region (regulatory restrictions) as well as Spreading Factor (SF) dependent.
Increasing the spreading factor improves the SNR but results in longer transmission times \cite{bor_lora_nodate}.
Using a higher bandwidth shortens the transmission times but reduces the maximum receiver sensitivity \cite{bor_lora_2016}.
Capacity calculations performed in \cite{mikhaylov_analysis_2016} revealed that when a single gateway must serve many devices the majority of them should be close to the gateway (SF = 7) as only a few nodes with the maximum SF can be supported given their long transmission times.
LoRa uses FEC to allow the recovery from transmission errors due to bursts of interference,
	but the use of FEC adds some encoding overhead [SX1272/3/6/7/8:
	LoRa Modem Designer’s Guide,].
LoRa’s coding rates are 4/(CR + 4) with CR ∈ {1, 2, 3, 4}.
A LoRa packet’s header and its Cyclic Redundancy Check (CRC) will always be transmitted using a CR of 4/8 and the payload with its optional CRC at the chosen coding rate [SX1272/3/6/7/8:
	LoRa Modem Designer’s Guide].
When LoRa is transmitting with a BW of 125 kHz and a SF of 11 or 12 a low data rate optimization can be enabled.
This reduces the impact on transmission due to drift in the reference frequency of the oscillator,
	but does add additional data overhead [SX1272/3/6/7/8:
	LoRa Modem Designer’s Guide,].
LoRa can detect channel activity using Carrier Activity Detection (CAD) \cite{bor_lora_nodate}.
This is faster than Received Signal Strength Indicator (RSSI) identification and can differentiate between noise or a desired LoRa signal [LoRa Modulation Basics].
B.
LoRaWAN LoRaWANs in Europe are limited to 10 channels,
	has duty cycle restrictions but no channel dwell time limitations.
LoRaWANs in North America have 64 channels,
	also have duty cycle restrictions but no channel dwell time limitations [A technical overview of LoRa and LoRaWAN].
LoRaWAN has 3 common 125 kHz channels for the 868 MHz band namely 868.10, 868.30 and 868.50 MHz that devices use to join the network [Indoor Deployment of LowPower Wide Area Networks (LPWAN):
	a LoRaWAN case study].
Once a node has joined the network,
	the network server can provide additional channels to the device.
In Europe,
	the same channels are used for uplink and downlink.
The network architecture is a star of stars topology in which end nodes connect directly communicate with gateways which in turn connect to a central network server \cite{bankov_limits_2016}.
Gateways are always on devices and have LoRa capabilities and potentially Ethernet or cellular capabilities to connect to the network server.
In a LoRaWAN transmissions are received by any nearby gateway(s).
This allows mobile nodes to transmit to any gateway without any handover.
The network server drops any copies of a message and replies using the optimum gateway [A technical overview of LoRa and LoRaWAN],
	\cite{wixted_evaluation_2016}.

\cite{slabicki_adaptive_2018} H6DXYYB9

Even though several articles studied the scalability of LoRa networks [Long-range communications in unlicensed bands:
	The rising stars in the IoT and smart city scenarios]\cite{petajajarvi_coverage_2015}\cite{augustin_study_2016},
	none of them has considered the impact of ADR on performance.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} propose an algorithm to select parameters such that transmission airtime and power are minimized.
However,
	the authors themselves described the proposed algorithm as optimistic and impractical;
	their goal was to show that improvements in network capacity are possible with dynamic data rates.
In contrast,
	we evaluate the ADR mechanism built into LoRaWAN and suggest a simple yet effective modification to improve its performance.
R
% -----------------------------------------------------
eynders et al.
\cite{reynders_power_2017} presented and evaluated a mechanism to optimize the fairness of packet error rates among nodes with different spreading factors.
We have applied a similar approach to derive the optimal distribution of spreading factors as a network-aware scheme in comparison with ADR+.
However,
	the scenario considered in \cite{reynders_power_2017} is such that all nodes in the network can reach the gateway with every spreading factor and every power setting,
	i.e.,
	all nodes are close to the gateway.
In contrast,
	we consider a more realistic deployment scenario wherein nodes may only reach the gateway with specific spreading factors and transmission powers.

% -----------------------------------------------------
Varsier et al.
\cite{varsier_capacity_2017} analyzed the capacity limits of LoRaWAN networks for smart metering applications.
The authors considered a distribution of spreading factors based on the median of the SNR values received at the gateway.
However,
	the exact details on how to configure the transmission parameters were not provided in their work.
In contrast,
	we have evaluated the impact of ADR on network performance and proposed modifications to the original ADR algorithms.

% -----------------------------------------------------
Kim et al.
\cite{kim_adaptive_2017} proposed a new ADR algorithm for LoRa networks at the nodes.
Their algorithm requires an active feedback channel,
	i.e.,
	an acknowledgment for every transmission.
However,
	this mechanism would decrease the delivery ratio as downlink traffic has been demonstrated to have an impact on uplink throughput \cite{pop_does_2017}.
In contrast,
	we show that ADR improves the efficiency of LoRa networks without the need for acknowledgments.
There are a few articles which present simulation tools 4 to evaluate the performance of LoRa networks.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} developed a Python-based discrete event simulator (called LoRaSim) to characterize the capacity of LoRa networks.
However,
	the simulator supports only uplink transmissions from nodes to the gateway;
	thus,
	it cannot be used to evaluate ADR.

% -----------------------------------------------------
Pop et al.
\cite{pop_does_2017} extended the LoRaSim simulator by adding support for downlink transmissions.
The authors demonstrated that downlink transmissions in the network actually decrease the communication performance of the wireless connections.

% -----------------------------------------------------
Van den Abeele et al.
\cite{abeele_scalability_2017} presented a LoRa simulator based on ns-3.
The work characterizes the scalability in scenarios with both uplink and downlink transmissions;
	however,
	it does not consider dynamic configuration of transmission parameters.

\cite{to_simulation_2018} 253585LX

Several authors studied the issue of limits to the capacity of LoRa and its scalability to a large number of devices.
Georgiou and Raza \cite{georgiou_low_2017} provided a stochastic geometry framework for modeling the performance of a single gateway LoRa network.
They showed that the coverage probability drops exponentially as the number of contending devices grows.
They concluded that LoRa networks will become interference-limited rather than noise-limited in dense deployment scenarios because of the LoRaWAN access method.

% -----------------------------------------------------
Augustin et al.
\cite{augustin_study_2016} presented throughput measurements on a testbed showing:
	i) less than 10\% of loss rate over a distance
of 2 km for SF 9-12 and ii) more than 60\% of loss rate over
3.4 km for SF 12.
They also simulated the LoRa behavior for a larger number of devices and showed that it behaves closely to ALOHA with the maximum channel capacity of 18\% and
an increasing collision ratio:
	for a link load of 0.48,
	the ratio is around 60\%.

% -----------------------------------------------------
Adelantado et al.
\cite{adelantado_understanding_2017} explored LoRa from the point of view of the capacity and the network size.
They observed that for low duty cycles,
	throughput is limited by collisions,
	whereas for higher duty cycle values,
	the maximum duty cycle set by the ETSI regulations prevents devices from increasing their packet transmission rates and limits throughput.
For instance,
	for 1000 devices,
	the maximum packet rate per node is 38 pkt/hour (packets of 50 B) with the probability of successful reception of only 13\%.

% -----------------------------------------------------
Reynders et al.
\cite{reynders_range_2016} compared the performance of LoRa and Ultra Narrowband (UNB,
	SIGFOX-like) networks with regard to the range and coexistence.
They showed that UNB MAC is slightly better than LoRaWAN:
	the latter discards both colliding packets at reception,
	while the UNB network enables reception of the strongest packet thanks to the capture effect.
The maximal throughput of the network occurs for 10 5 devices in the network,
	but results in a packet loss of 63\%.

% -----------------------------------------------------
Haxhibeqiri et al.
\cite{jetmir_haxhibeqiri_lora_2017} investigated the scalability of LoRa in terms of the number of devices per gateway.
They used a simulation model based on the measurements of the interference behavior between two nodes to show that when the number of nodes with the duty cycle of 1\% increases to 1000 per gateway,
losses increase to 32\%.
However,
	this level of the loss rate should be considered as low compared to 90\% in pure ALOHA
for the same load and it results from taking into account the capture effect,
	which apparently plays an important role in the LoRa behavior.
We compare their measured packet loss rate and collision ratio with the simulation results.

% -----------------------------------------------------
Mikhaylov et al.
\cite{mikhaylov_analysis_2016} showed that a LoRa cell can potentially serve a large number of devices,
	but devices are limited to sending only a few bytes of data per day.
The majority of devices need to be located in the vicinity of the gateway:
	only less than 10\% can reside at distances longer
than 5 km.
Another factor that limits scalability is the use of acknowledgements—as the gateway is subject to the same ETSI restrictions on the duty cycle,
	it cannot acknowledge each packet in a dense network.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_nodate} developed a LoRa simulation to study its scalability.
They showed that a typical Smart City deployment can support 120 nodes per 3.8 ha,
	which is not sufficient for future IoT deployments.
Other studies in the literature analyzed the performance of the LoRa modulation—Goursaud and Gorce \cite{goursaud_dedicated_2015} considered other technologies (SigFox,
	Weightless,
	and RPMA by Ingenu) in addition to LoRa to highlight their pros and cons.

% -----------------------------------------------------
Ochoa et al.
\cite{ochoa_evaluating_2017} proposed various strategies to adapt LoRa radio parameters to different deployment scenarios.
Their simulation results showed that in a star topology,
	we can achieve the optimal scaling-up/down strategy of LoRa radio parameters to obtain either a high data rate or a long range while respecting low energy consumption.
All the analyses show a large space for possible improvement of the LoRa performance.
Nevertheless,
	the proposals for enhanced access methods need to take into account energy consumption along with performance,
	which is our goal in the next sections.

\cite{zorbas_improving_2018} D8LVPLDY

% -----------------------------------------------------
Raza et al.
\cite{raza_low_2017} present the five key challenges for LPWAN and compare proprietary and standard technologies,
	including LoRa,
	Sigfox, 802.15.4g or Dash7 to cite a few.
These challenges are ultra low-power operation and long range communication,
	since it is expected to cover wide areas for several years.
To this aim, 1-hop networks and duty cycling are employed.
Low cost is also another challenge for LPWAN.
Finally,
	scalability and quality of service are also challenges given the expected number of connected objects,
	and the variety of expected services.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} present LoRaSim,
	a simulator to evaluate the scalability of LoRa networks.
The authors detail range of communication options (carrier frequency,
	spreading factor,
	bandwidth and coding rate) for a transmitter.
Moreover,
	they study the collision avoidance scenarios as well as the maximum number of transmitters in a LoRa network.
Their evaluation results show that to keep the Data Extraction Rate above 0.9,
	only 120 users are supported per antenna using standard LoRa settings.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_nodate} also propose LoRaBlink,
	a MAC and routing cross-layer scheme,
	above the LoRa physical layer to extend the radio coverage of the gateway.
LoRaBlink is self-organized network based on beacons (that contains distance in hops from the sink) and time-slotted channel access method.
Their performance evaluation show that LoRaBlink may cover a network of 1.5 ha in a built up environment,
	achieve 80\% of
reliability while having a potential lifetime of 2 years.

% -----------------------------------------------------
Voigt et al.
\cite{voigt_mitigating_2016} investigate the use of directional antennae and the use of multiple base stations as methods of dealing with internetwork interference.
Simulation results show that the use of multiple base stations outperforms the use of directional antennae.

% -----------------------------------------------------
Georgiou and Raza \cite{georgiou_low_2017} provide a stochastic geometry framework for modeling the performance of a single gateway LoRa network.
They model the co-spreading factor interference assuming a single bandwidth frequency for all the nodes and they measure the outage and coverage probabilities based on the signal to noise ratio and the co-spreading sequence interference.
Their analysis shows that the coverage probability drops exponentially as the number of end-devices grows due to interfering signals using the same spreading sequence.

% -----------------------------------------------------
Abeele et al.
\cite{abeele_scalability_2017} using a LoRa ns-3 module,
	perform a scalability analysis of LoRaWAN.
Their work shows detrimental impact of the downstream traffic on the delivery ratio of the upstream traffic.
They,
	also,
	show that increasing gateway density can ameliorate but not eliminate this effect,
	as stringent duty cycle requirements for gateways continue to limit downstream opportunities.
The same authors show through simulations that LoRaWAN can send six times more traffic compared to pure Aloha in a single-cell LoRaWAN network for the same number of end devices per gateway when the 125-kHz channel bandwidth is used \cite{jetmir_haxhibeqiri_lora_2017}.

% -----------------------------------------------------
In \cite{bankov_mathematical_2017},
	Bankov et al.
consider LoRaWAN networks with class A devices operating in acknowledged mode.
They detail the data transmission process,
	considering the difference between power of the signal from different devices and the capture effect.
Indeed,
	they developed a generic mathematical model which can be employed to evaluate network capacity and transmission reliability of LoRaWAN networks when considering Okumura-Hata model for propagation losses.
In this paper,
	unlike other works,
	we thoroughly study LoRa performance by presenting both packet success probability as well as the average success probability per frequency and spreading factor configuration as a function of distance and density.
We solve an optimization problem for each frequency to find the optimal mix of nodes with different configurations that maximize the density and do not violate a minimum average success probability.

\cite{abdelfadeel_fair_2018} S7MJTV2C

Here we provide an overview of the LoRaWAN protocol stack and highlight related work in the LoRaWAN domain.
A.
Long Range (LoRa) LoRa is a proprietary low-cost implementation of Chirp Spread Spectrum (CSS) modulation by Semtech that provides long range wireless communication with low power characteristics [An1200.22,
	lora modulation basics] and represents the physical layer of the LoRaWAN stack.
CSS uses wideband linear frequency modulated pulses,
	called chirps to encode symbols.
A LoRa symbol covers the entire bandwidth,
	making the modulation robust to channel noise and insensitive to frequency shifts.
LoRa modulation

is defined by two main parameters:
	Spreading Factor sf ∈ SF s(7,
	..., 12),
	which affects the number of bits encoded per symbol,
	and Bandwidth bw ∈ BW s(125, 250, 500)KHz,
	which is the spectrum occupied by a symbol.
A LoRa symbol consists of 2 sf chirps in which chirp rate equals bandwidth.
LoRa supports forward error correction code rates cr equal to 4/(4 + n) where n ranges from 1 to 4 to increase resilience.
The theoretical bit rate R b of LoRa is shown in Eq. 1 [An1200.22,
	lora modulation basics].
bw ∗ cr bits/s (1) 2 sf Moreover,
	a LoRa transceiver allows adjusting the Transmission Power T P .
Due to hardware limitations the adjustment range is limited from 2dBm to 14dBm in 1dB steps.
A LoRa packet can be transmitted using a constant combination of SF ,
	BW ,
	CR and T P ,
	resulting in over 936 possible combinations.
Tuning these parameters has a direct effect on the bit rate and hence the airtime,
	affecting reliability and energy consumption.
Each increase in SF nearly halves the bit rate and doubles the airtime and energy consumption but enhances the link reliability as it slows the transmission.
Whereas each increase in the BW doubles the bit rate and halves the airtime and energy consumption but reduces the link reliability as it adds more noise.
The airtime of a LoRa packet can be precisely calculated by the LoRa airtime calculator [Lora modem design guide].
Fig. 1a shows the effect of SF s and BW s at code rate CR = 4/5 on the airtime to transmit an 80 bytes packet length.
As shown,
	the fastest combination uses the lowest SF with the highest BW ,
	whereas,
	the highest SF with the lowest BW achieves the slowest combination.
Fig. 1b shows the energy consumption for combinations of SF s and T P s at CR = 4/5 and BW = 500KHz to transmit an 80 bytes packet.
As shown,
	the SF has much higher impact than the T P on the energy consumption,
	e.g.
increasing SF consumes more energy than increasing T P especially for large SF s.
LoRa modulation can enable concurrent transmissions,
	exploiting the pseudo-orthogonality of SF s as long as none of the simultaneous transmissions is received with significantly higher power than the others \cite{goursaud_dedicated_2015}.
Otherwise,
	the strongest transmission suppresses weaker transmissions if the power difference is higher than the Co-channel Interference Rejection (CIR) of weaker SF s.
In case of the same SF ,
	all simultaneous transmissions are lost,
	unless one of the transmissions is received with higher power than the CIR of the SF .
This suppression of weaker signals by the strongest signal is called capture effect \cite{bor_lora_2016}.
The CIR of all SF pairs has been calculated using simulations in \cite{goursaud_dedicated_2015} and validated by real LoRa link measurements in \cite{piva_impact_2017}.

Recent research on LoRa/LoRaWAN has mainly focused on LoRa performance evaluation in terms of coverage,
	capacity,
	scalability and lifetime.
The studies have been carried out using real deployments in \cite{oliveira_long_2017} and \cite{petajajarvi_performance_2017},
	mathematical models in [Mathematical model of lorawan channel access] and \cite{georgiou_low_2017},
	or computer simulations in \cite{bor_lora_2016} and \cite{magrin_performance_2017}.
Almost all these works have assumed perfectly orthogonal SF s although it has been shown in \cite{mikhaylov_lorawan_2017} and \cite{piva_impact_2017} that this is not a valid assumption.
Furthermore,
	recent work has proposed transmission parameter allocation approaches for LoRaWAN with different objectives.
For example,
	authors in \cite{bor_lora_2017} proposed a transmission parameter selection approach for LoRa to achieve low energy consumption at a specific link reliability.
Here a LoRa node probes a link using a transmission parameter combination to determine the link reliability.
It then chooses the next probe combination based on whether the new combination achieves lower energy consumption while maintaining at least the same link reliability.
Finally,
	the approach terminates when reaching the optimal combination from an energy consumption perspective.

% -----------------------------------------------------
Authors in \cite{cuomo_explora_2017} proposed two SF allocation approaches,
	namely EXP-SF and EXP-AT,
	to help LoRaWAN achieve a high overall data rate.
EXP-SF equally allocates SF s to N nodes based on the Received Signal Strength Indicator (RSSI),
	where the first N/6 nodes with the highest RSSI get SF 7 assigned and then the next N/6 nodes SF 8 and so on.
EXP-AT is more dynamic than EXP-SF,
	where the SF allocation theoretically equalizes the airtime of nodes.

% -----------------------------------------------------
The two aforementioned works \cite{bor_lora_2017} and \cite{cuomo_explora_2017} assumed perfectly orthogonal SF s,
	which leads to a higher overall data rate than in reality.
In the context of our work presented here,
	allocating data rates and T P s to achieve data rate fairness in LoRaWAN is not well investigated,
	with the exception of \cite{reynders_power_2017},
	where authors proposed a power and spreading factor control approach to achieve fairness within a LoRaWAN cell.
We provide an overview of \cite{reynders_power_2017} and a detailed comparison with our proposal in Section IV.
While in general data rate and power control approaches have been well studied for cellular systems and WiFi [A framework for uplink power control in cellular radio systems] \cite{subramanian_joint_2005},
	we argue that these solutions are not suitable for constrained systems like LoRaWAN.
The reason is that cellular based approaches require fast feedback and high data rates to work,
	which are not available in LoRaWAN.
In the end,
	an interesting work was done to ensure an interoperability between LoRaWAN and the native IoT stack i.e.
IPv6/UDP/CoAP at the device level.
The interoperability was done by adopting legacy solution like 6LoWPAN over LoRaWAN \cite{weber_ipv6_2016} or by developing a new header compression technique to be more suitable for the constraints of LoRaWAN [Lschc:
	Layered static context header compression for lpwans].

\cite{abeele_scalability_2017} J22SN85R

A number of works have been published in literature that study the scalability of LoRa(WAN) LPWA networks.

% -----------------------------------------------------
In one of the first works on this topic,
	Mikhaylov et al.
\cite{mikhaylov_analysis_2016} present an analysis of the capacity and scalability of LoRa LPWANs.
The authors perform an analytical analysis of the maximum throughput for a single LoRaWAN end device,
	taking into account such factors as RDC and the influence of receive windows.
The authors note that receive windows drastically increase the time between subsequent transmissions and that RDC restrictions reduce the maximum throughput further.
The authors applied the same methodology to determine the capacity of LoRaWAN based on ALOHA access.
While it is true that the LoRaWAN MAC access is an ALOHA scheme,
	empirical data has shown that the assumptions made in pure ALOHA access do not adequately model a LoRaWAN network (see figure 4 in \cite{bor_lora_2016}).
Specifically,
	it fails to model the interference between concurrent transmissions as pure ALOHA assumes concurrent transmissions are always lost regardless of their received power levels,
	timings and the presence of forward error correction.

% -----------------------------------------------------
A second,
	but similarly lacking,
	pure ALOHA capacity analysis of LoRaWAN is discussed in \cite{augustin_study_2016}.
In \cite{adelantado_understanding_2017} Adelantado et al.
also calculate LoRaWAN capacity as the superposition of independent ALOHA-based networks (one for each channel and for each SF).
In conclusion,
	analyses based on pure ALOHA,
	fail to adequately model interference in LoRaWAN networks and therefor underestimate the capacity of LoRaWAN LPWANs.

% -----------------------------------------------------
In \cite{georgiou_low_2017},
	Georgiou and Raza provide a stochastic geometry framework for modeling the performance of a single channel LoRa network.
Two independent link-outage conditions are studied,
	one which is related to SNR (i.e.
range) and another one which is related to co-spreading factor interference.
The authors argue that LoRa networks will inevitably become interference-limited,
	as end device coverage probability decays exponentially with increasing number of end devices.
The authors report that this is mostly caused by co-spreading factor interference and that the low duty cycle and chirp orthogonality found in LoRa do little to mitigate this.
Finally,
	the authors note that the lack of a packet-level software simulation is hindering the study into the performance of LoRa.
It would be interesting to combine the authors’ modeling of co-spreading factor interference with our ns-3 error model,
	as in the SINR approach all interference is treated as noise.

% -----------------------------------------------------
The work of Bor et al.
\cite{bor_lora_2016} studies the limit on the number of transmitters supported by a LoRa system based on an empirical model.
The authors performed practical experiments that quantify communication range and capture effect of LoRa

transmissions.
These findings were used to build a purposebuilt simulator,
	LoRaSim,
	with the goal of studying the scalability of LoRa networks.
The authors conclude that LoRa networks can scale quite well if they use dynamic transmissions parameter selection and/or multiple sinks.
Our study confirms that multiple sinks drastically improve scalability,
	even though we use a very different approach for modeling interference.
Furthermore,
	our study goes deeper into modeling LoRaWAN as the LoRaWAN MAC layer is modeled and the impact of confirmed messages and downstream traffic is studied.

% -----------------------------------------------------
The recent work presented by Pop et al.
in \cite{pop_does_2017} studies the impact of bidirectional traffic in LoRaWAN by extending the LoRaSim simulator to include bidirectional LoRaWAN communication.
The resulting simulator is named LoRaWANSim.
Both our ns-3 module and LoRaWANSim allow to study the scalability of LoRaWAN networks.
Both works find that duty cycle limitations at the gateway limit the number of downlink messages (Ack or data) a gateway can send.
This problem grows worse as the end device density increases,
	but can be partially mitigated by increasing gateway density (see section V-C).

% -----------------------------------------------------
The authors of \cite{pop_does_2017} correctly identify that the absence of an acknowledgement,
	does not necessarily mean that the link quality has decreased and that a node should decrease its data rate for subsequent retransmissions.
Actually,
	decreasing the data rate might exacerbate this problem as detailed in \cite{pop_does_2017}.
Notable differences between the two simulators include that the LoRaWANSim manuscript is limited to single gateway network,
	while the ns-3 module provides support for multi-gateway LoRaWAN networks.
Secondly,
	the collision models are quite different.
The ns-3 module builds on the error model derived from the complex baseband BER simulations,
	while LoRaWANSim reuses the empirical model from LoRaSim.
Both collision models support the capture effect as well as modeling interference.
Under capture effect,
	we understand the ability to receive an interfered transmission in the presence of one or more interferers as long as the SNR of the interfered transmission is sufficiently high for the transmission to be received error-free.
The LoRaWANSim collision model incorrectly assumes perfect orthogonality between spreading factors,
	while the ns-3 module counts every transmission on the same channel with a different spreading factor as interference.
Furthermore,
	the LoRaWANSim manuscript does not mention the 10\% RDC restriction that applies in the sub-
band of the RW2 channel in the EU.
This underestimates the downlink capacity in RW2.
Thirdly,
	the SpectrumPhy model for the LoRa PHY in ns-3 enables modeling inter-technology interference,
	which could facilitate studies on the interference between 802.11ah on LoRaWAN.
Finally,
	the LoRaWANSim simulator does not appear to be open source although the manuscript is still under revision at this time.

\cite{blenn_lorawan_2017} P8FP2R7R


% -----------------------------------------------------
Vangelista et al.
\cite{atanasovski_long-range_2015} present LoRa as “one of the most promising technologies for the wide-area IoT” and mention that LoRa exhibits certain advantages over the LPWAN technologies Sigfox TM ,
	Weightless TM ,
	and On-Ramp Wireless.
The robust chirp signal modulation and the low energy usage in combination with the low cost of end-devices together with the fact that the LoRa Alliance is also actively marketing and pushing interoperability aspects,
	makes LoRaWAN an interesting choice among available LPWAN technologies.
In [Long-range communications in unlicensed bands:
	the rising stars in the iot and smart city scenarios],
	Centenaro et al.
provide an overview of the LPWAN paradigm in the context of smart-city scenarios.
The authors also test the coverage of a LoRaWAN gateway in a city in

Italy,
	by using a single base-station without antenna gain.
The covered area had a diameter of 1.2 km.

% -----------------------------------------------------
The expected coverage of LPWANs and especially LoRa was also analyzed by Petäjäjärvi et al.
\cite{petajajarvi_coverage_2015},
	who conducted measurements in Finland.
Using a single base-station with an antenna gain of 2 dBi and configuring the nodes to send packets at SF12 using 14 dBm of transmit power,
	connectivity within a 5 km range in urban environments and 15 km in open space were found to result in packet-loss ratios smaller than 30\%.
Measurements conducted by sending packets from a node mounted to a boat revealed that packets can be sent over a distance of almost 30 km.

% -----------------------------------------------------
Petäjäjärvi et al.
\cite{petajajarvi_evaluation_2017} also tested the usage of LoRa in indoor environments.
The results show that very low packet-loss is to be expected with only one base-station to cover an average university campus.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_nodate} conducted experiments using multiple nodes transmitting data using LoRa.
Experiments were conducted in which two devices sent packets at different power levels,
	but the same spreading factor,
	to estimate the influence of concurrent transmissions.
Additionally,
	a new media access control (MAC),
	LoRaBlink,
	was developed to enable direct connection of nodes without using LoRaWAN.
Contrary to the above-mentioned work,
	we have not confined to a single base-station,
	but we have provided extensive measurements based on the large-scale “The Things Networks” network and for a duration of 8 months.

\cite{hoeller_analysis_2018} S33CL98I

Several recent related works have sought to evaluate the performance of LoRa networks using analytic modeling  \cite{georgiou_low_2017}–  \cite{bor_lora_2016}
\cite{gupta_modelling_2017}
\cite{pop_does_2017}
\cite{bankov_mathematical_2017}
and real measurements  \cite{petajajarvi_performance_2017}
\cite{petajajarvi_evaluation_2017}
\cite{wang_performance_2017}
\cite{neumann_indoor_2016}
\cite{angrisani_lora_2017}
\cite{jorke_urban_2017}
\cite{radcliffe_usability_2017}
\cite{rizzi_evaluation_2017}
\cite{oliveira_long_2017}.
Additionally,
	a few techniques have been proposed to enhance the performance of LPWANs in general,
	with potential modifications to the current technologies,
	as for LoRa in \cite{cuomo_explora_2017}
\cite{bor_lora_2017}
\cite{qin_resource_2017}
\cite{voigt_mitigating_2016},
	UNB/S IG F OX in \cite{mo_optimization_2016},
	and for others in \cite{song_evaluation_2017},
	\cite{magrin_performance_2017}.
Analytic models have been proposed for a variety of scenarios and communication phenomena.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_2016} experimentally observed the capture effect of LoRa and modeled the capacity of such networks,
	concluding that LoRa networks with only one gateway and conservative operational parameters do not scale well,
	while networks with dynamic adaptation of operating parameters or multiple gateways tend to scale better.

% -----------------------------------------------------
Georgiou and Raza \cite{georgiou_low_2017} propose an analytic model that takes into account Rayleigh fading and allows to equate the coverage probabilities of nodes in a network considering two outage probabilities:
	disconnection and collision.
Their work shows that LoRa networks are sensitive to network density.

% -----------------------------------------------------
Gupta et al.
\cite{gupta_modelling_2017} modeled the IoT traffic considering periodic messages and event-generated messages and analyzed the impact of traffic variations in LoRa WAN networks.
They were able to identify that LoRa gateways do not handle well burst events,
	which generate a significant amount of messages in a short period,
	especially when there is a spatial or temporal correlation in the transmission behavior of IoT devices.

% -----------------------------------------------------
Pop et al.
\cite{pop_does_2017} evaluated how LoRa WAN downlink impacts LoRa uplink goodput and coverage probability.
They considered the medium access control (MAC) layer and,
	through simulations,
	verified that if too many end-devices request delivery confirmation,
	the downlink becomes unstable and unable to deliver several acknowledgment packets,
	thus forcing network nodes to retry their transmissions,
	ultimately flooding the network.

% -----------------------------------------------------
Bankov et al.
\cite{bankov_mathematical_2017} proposed a mathematical model for LoRa WAN channel access taking into account the capture effect and using the Okumura-Hata model,
	but without fading.

% -----------------------------------------------------
Concerning the modeling of communication fading,
	only Georgiou and Raza \cite{georgiou_low_2017} and Pop et al.
\cite{pop_does_2017} take this impairment into account,
	to the best of our knowledge.
Several works have used measurements to evaluate the performance of LoRa networks.

% -----------------------------------------------------
Petäjäjärvi et al.
\cite{petajajarvi_performance_2017},
	\cite{petajajarvi_evaluation_2017} analyze Doppler robustness,
	scalability,
	and coverage of LoRa networks and report the experimental validation of such metrics in terrestrial and water environments for static and mobile nodes.
Considering a delivery ratio of at least 60\% and
LoRa most conservative configurations,
	they were able to communicate to static nodes ranging up to 30 km over the water and up to 10 km on the ground.
Regarding Doppler robustness,
	they observed that communication degrades significantly when the velocity of the node in relation to the gateway is above 40 km/h.
There are similar reports of LoRa measurements done in different environments,
	including a university campus \cite{wang_performance_2017},
	indoor applications [Indoor deployment of lowpower wide area networks (LPWAN):
	A LoRaWAN case study],
	industry \cite{angrisani_lora_2017},
	dense cities downtown \cite{jorke_urban_2017},
	[Usability of LoRaWAN technol],
	smart metering \cite{rizzi_evaluation_2017},
	and rural areas \cite{oliveira_long_2017}.
Albeit these measurements show interesting results,
	it is important to note that none of them used a large number of network nodes,
	thus making it difficult to validate models for dense networks.
A few recently published work also propose some enhancements to LoRa .

% -----------------------------------------------------
Cuomo et al.
\cite{cuomo_explora_2017} propose algorithms to replace LoRa WAN adaptive data rate strategy.
The proposed algorithms do not base the configuration of the spreading factor (SF) on distance and received power measurements,
	but take into account the number of connected devices,
	allowing the equalization of the time-on-air (ToA) of the packets in each SF.

% -----------------------------------------------------
Bor and Roedig \cite{bor_lora_2017} explore LoRa configuration parameters such as SF,
	bandwidth,
	coding rate and transmission power,
	which result in 6, 720 possible settings,
	and proposes an optimization problem that minimizes energy spent on data transmission while meeting required communication performance.

% -----------------------------------------------------
Qin and McCann \cite{qin_resource_2017} approach the optimization of LPWANs efficiency from a resource allocation perspective.
They use game theory to derive an algorithm that allows network nodes to decide which channel and SF to use and,
	for each channel/SF group,
	which is the optimal transmit power that maximizes data extraction rate.

% -----------------------------------------------------
Voigt et al.
\cite{voigt_mitigating_2016} consider the inter-network interference that is likely to take place when several independent LoRa networks get deployed too close.
Authors consider using directional antennas in network nodes and using multiple gateways in the network.
Results show that directional antennas enhance data extraction rate,
	although the use of multiple gateways in the covered area tends to perform better.
Besides the above works,
	some authors have explored techniques similar to those proposed in this paper for LoRa ,
	UNB/S IG F OX ,
	or for LPWANs in general.

% -----------------------------------------------------
Mo et al.
\cite{mo_optimization_2016} investigated the optimal number of message replications for use in UNB/S IG F OX networks.

% -----------------------------------------------------
Song et al.
\cite{song_evaluation_2017} consider the macro reception diversity of long-range ALOHA networks,
	where augmented spatial diversity arises from allowing several base stations to receive the same packet.

% -----------------------------------------------------
Magrin et al.
\cite{magrin_performance_2017} developed a simulation model for the NS-3 network simulator with which they showed that LoRa networks support a large number of nodes and maintain reasonable network quality if several gateways are carefully placed.
In this paper,
	we model and validate the behavior of LoRa networks using message replication to exploit time diversity and using a single gateway with multiple receive antennas to exploit spatial diversity,
	striving to maximize network performance.
To do that,
	we take the work of \cite{georgiou_low_2017} as baseline model and extend it to incorporate the proposed techniques.
Our work on message replication differs from \cite{mo_optimization_2016} because that work considers UNB networks where each transmission uses a random central frequency – an assumption that changes the collision model.
Moreover,
	our work takes fading into account,
	what \cite{mo_optimization_2016} does not.
Our approach using multiple receive antennas differs from \cite{song_evaluation_2017} and \cite{magrin_performance_2017} because they consider spatial diversity generated by multiple gateways.
Our work examines the case where multiple receive antennas in a single gateway create signal diversity able to enhance signal quality,
	an approach that can be naturally extended to the case of multiple gateways in the future.
To the best of our knowledge,
	no work has investigated the use of multiple receive antennas and message replications in LoRa networks.

\cite{kim_experiencing_2019} DFN3W8GF


% -----------------------------------------------------
Noreen et al.
described LoRa PHY performance theoretically \cite{noreen_study_2017}.
They explained the transmission rate in terms of three basic parameters:
	BW,
	CR,
	and SF.
Their results show that increasing the packet length results in a sharp increase in ToA.
SK Telecom [sktiot.com],
	a leading telecommunication operator in Korea,
	presented its experimental results on LoRa transmission ranges at the IoT-LPWA working conference in 2016.
LoRa nodes that are located outdoors transmit packets to a LoRa gateway with an output power of 14 dBm.
In the experiment,
	the SF was set to 12,
	and retransmission was not conducted.
The company announced that transmission ranges of 1.09 km, 1.54 km,
	and 3.03 km are achievable for dense urban,
	urban,
	and suburban areas,
	respectively.
These specified values satisfy the requirement for a LoRa transmission success rate of above 90\%.
The researchers also deployed nodes inside the buildings on the first floor and performed a similar test.
In this case,
	the communication coverage was measured to be about 2/3 of the performance measured outdoors.

% -----------------------------------------------------
Augustin et al.
\cite{augustin_study_2016} reported the result of suburban experiments in Paris.
Cisco 910 as a gateway was installed outside a residential window at a height of about 5 meters.
LoRa nodes were placed in 5 different locations so that their distances from the gateway were 600 m, 1400 m, 2300 m, 2800 m,
	and 3400 m.
There were 3 options for SF values: 7, 9,
	and 12.
The adaptive data rate and retransmission were not used.
Experimental results show that the PDR is about 90\% when SF 12 is used at 2800 m,
and the ratio drops to less than 10\% at SF 9.
At 3400 m,
	only about 40\% of the received packets have SF 12.

% -----------------------------------------------------
Wixted et al.
\cite{wixted_evaluation_2016} evaluated the LoRa coverage in the Central Business District in Glasgow,
	Scotland.
A LoRa gateway was installed on the roof of the 7th floor of a university building.
Carrying nodes with SF 12 in a backpack,
	a tester moved around the city and measured the received signal strength.
The experimental result shows that it is possible to successfully receive packets 2.2 km in the south direction and 1.6 km in the north direction (before passing through the hill).
The authors mentioned that the east and west directions were not fully tested but were measured to about 2 km.

% -----------------------------------------------------
Erbati et al.
[Analysis of LoRaWAN technology in an Outdoor and an Indoor Scenario in Duisburg-Germany] analyzed LoRa performance in an outdoor environment in Duisburg,
	Germany.
A LoRaWAN gateway was installed in an eight-story building located in the city of Duisburg.
Experiments were conducted in a non-LOS real-world environment where there exist various obstacles,
	such as buildings,
	cars,
	and trees.
The distance varied from 300 m to 1850 m,
	and 500 data were sent

from each spot.
The following parameter settings were used: 21 bytes of payload,
	a CR of 4/5,
	SF 10,
	and 125 kHz bandwidth.
Results show that the Received Signal Strength Indication (RSSI) value decreases logarithmically with increasing distance.
A data packet is not decoded anymore when the distance becomes greater than 1,850 m,
	where a PDR of 69\% is achieved.

% -----------------------------------------------------
Newmann et al.
\cite{neumann_indoor_2016} deployed both the gateway and nodes inside to study LoRa performance in an indoor environment.
In the experiments,
	the distances between nodes and the gateway were 0.50 ∼ 60 m.
The result shows that RSSI decreases rapidly on a log scale with increasing distance compared with the outdoor environment,
	but it is reliable enough to be used indoors.
However,
	when the distance becomes very small,
	packet errors occur frequently as a result of a bad cyclic redundancy check (CRC).

% -----------------------------------------------------
Adelantado et al.
\cite{adelantado_understanding_2017} referred to the duty-cycle constraint as a major factor limiting LoRa MAC performance.
A higher SF value allows a wider communication range but also increases the ToA,
	which inevitably leads to an increase in the off-period duration under the constraint.
The problem can be serious because,
	generally,
	nodes using high SF values are much more numerous than nodes using low SF values.
The study applied 3 channels and a 1\% duty cycle as the fixed parameters and simulated
the packet reception ratio for a given packet length and number of nodes.
As a result,
	although the packet length is small at 10 bytes,
	the packet reception rate decreases exponentially because of the increasing number of collisions as the number of nodes increases.
Notably,
	it converges to almost zero when more than 1500 nodes are deployed.
On the contrary,
	a small number of nodes decreases the probability of collision,
	but the throughput is limited by the duty cycle.

% -----------------------------------------------------
Abeele et al.
\cite{abeele_scalability_2017} analyzed the scalability of large-scale LoRaWAN using the NS-3 simulator.
LoRa MAC has been modeled as a pure ALOHA network that does not consider the capture effect or interference characteristics.
Instead,
	the authors generated a LoRa error model from a preliminary simulation that measured the bit error rate on the baseband and used it as an interference model in the simulator.
The simulation result shows that the packet reception ratio varies depending on how SF values are assigned when nodes are deployed.
Performance is very poor when all nodes have the same SF.
Assigning SF values randomly results in better performance than the fixed SF assignment,
	but it is still low:
	only a 20\% ratio with 5000 nodes.
They improved the performance by about two times compared with the random assignment method by using a PER (packet error rate) strategy that assigns the minimum SF value at which the PER falls below a certain threshold.
The authors ran another experiment that set the size of an application payload to 8 bytes and used a single channel.
In this experiment,
	they increased the data period from 600 s to 60,000 s,
	varied the number of gateways from 1 to 4,
	and then evaluated MAC performance.
Their results confirm that the PDR increases exponentially as the data period increases.
With respect to the gateways,
	the PDR achieves 70\%, 89\%,
and 96\% when 1, 2,
and 4 gateways are deployed in an area with 10,000 nodes that send data every 600 s.
This illustrates the possibility of using multiple gateways to improve LoRa performance in a dense environment.
Our experiments used the LBT scheme on multiple channels,
	so it is impossible to compare our results to theirs directly.
However,
	both results indicate that there is a trade-off between the number of nodes and the data period to achieve a given level of LoRa MAC performance.

% -----------------------------------------------------
To and Duda \cite{to_simulation_2018} applied a Carrier-Sense Multiple Access (CSMA) technique to LoRa to improve LoRa scalability.
When a node has a packet to send,
	it performs a Clear Channel Assessment (CCA) to test whether there is an ongoing transmission on a channel.
The node transmits the packet only if the channel is clear;
	otherwise,
	it backs off for a random interval of time,
	with k slots of 1’s,
	where k ∈ [ 0, 2 n − 1 ] .
The authors further proposed CSMA-10,
	a variant of CSMA,
	where the node listens to the channel,
	named the Clear Channel Gap (CCG),
	for an interval of 10 ms before attempting transmission.
Their experimental results show that the proposed method can mitigate the probability of packet collision.
This allows the deployment of 5500 nodes with a 90\% PDR,
whereas a general LoRaWAN deployment only allows less than 500 nodes to achieve the same packet delivery ratio.

\cite{lavric_performance_2018} EKZHXVKL


% -----------------------------------------------------
Mikhaylov et al.
\cite{mikhaylov_analysis_2016} analyzed and assessed the throughput of the LoRa technology,
	determining the airtime of a packet.
Therefore,
	it is possible to estimate the maximum number of nodes that can communicate with a Gateway module.
The purpose of this paper was to analyze the ALOHA communication mechanism.
The results are obtained at an empirical level.
A mathematical model of the access mechanism to the communication channel is presented in \cite{bankov_mathematical_2017}.
A certain threshold of the network load is also calculated in this paper by estimating the throughput.
When this threshold value is reached,
	the PER (Packet Error Rate) parameter increases rapidly towards 1,
	because the packet relaying causes an avalanche effect leading to the saturation of the communication channel.

% -----------------------------------------------------
Bor et al.
\cite{bor_lora_nodate} analyzed the access mechanism of the communication channel.
From the obtained results,
	it can be seen that when the same SF (spreading factor) is used,
	by both the receiver and the transmitter,
	the packets are received even if a third node attempts to interfere with the transmission.
Thus,
	the separation of channels by using different SF proves effective.
One or two simultaneous transmissions can be received with high probability,
	if there is a separation of at least 3 symbol periods between them.
The paper also analyzes the possibility of implementing a carrier activity detection mechanism.
An algorithm for the automatic selection of communication parameters is presented in \cite{bor_lora_2017} so as to achieve a performance level as high as possible,
	at the same time ensuring energy efficiency.

% -----------------------------------------------------
Blenn N.
et al.
\cite{blenn_lorawan_2017} obtained a series of experimental and empirical results by analyzing the influence of the payload on the quality of the received signal.
The experiments have been conducted over an 8-month period,
	with the results showing that the LoRa channel occupancy rate is not evenly distributed,
	a fact that contributes to a decrease in performance.
This phenomenon is based on the fact that the majority of LoRa nodes use the default settings programmed by the manufacturer,
	a fact that causes the overload of certain channels.
The purpose of the paper was to use certain user-defined communication channels according to the RF (Radiofrequency) environment congestion.

% -----------------------------------------------------
In \cite{petajajarvi_performance_2017},
	the Doppler effect over the LoRa modulation is analyzed,
	by performing a series of experimental measurements.
From the obtained results,
	the authors conclude that,
	by using SF=12,
	a communication range of up to 30 km with a packet loss of 62 \% can be obtained.

% -----------------------------------------------------
In \cite{vangelista_frequency_2017} the mathematic model of the LoRa modulation and also of the demodulation process based on signal processing theory is presented.
The paper also presents a comparison of the performance levels between the LoRa modulation and the FSK (Frequency-Shift Keying) modulation,
	regarding the value of the encoded bit error rate parameter.
The obtained results show that when an AWGN (Additive White Gaussian Noise) channel is used,
	the LoRa modulation ensures a higher performance level.

% -----------------------------------------------------
Liao et al.
\cite{liao_multi-hop_2017} analyze the effect of the simultaneous LoRa transmissions over the performance level.
The paper proposes the integration of a CT (Concurrent Transmission) type flooding into the technology.
CT is an extremely efficient flooding type protocol that has recently revolutionized the design of the multihop networks based on the IEEE-802.15.4 standard.
Instead of attempting to avoid packet collision,
	CT enables more nodes to send packets with the same content simultaneously,
	at the same time moment.
By allowing such synchronized packets collisions,
	CT enables rapid backto-back relaying of packets that considerably improve the efficiency of the network.
The paper proposes the implementation of such a strategy for increasing the performance level of the LoRa networks by introducing a multihop mechanism.
None of the papers evaluate the maximum number of nodes that can communicate on a channel,
	taking into consideration a real implementation scenario.

\cite{li_2d_2016} AAHXK9LU

Multiple works exist for the performance evaluation of LPWANs \cite{mikhaylov_analysis_2016},
	\cite{goursaud_random_2016},
	\cite{adelantado_understanding_2017},
	\cite{reynders_range_2016}.
Most of these works use Poisson processes to model the packet arrival,
	which we believe is not the most adapted for periodic packet sending scenarios in LPWANs.
For example,
	a device reporting on a daily basis would not send more than one message per day.
However,
	as Poisson models the intensity of packet arrival,
	an intensity of one message per day represents in fact the mean value,
	i.e.,
	one message on average per day,
	which is not quite the case described.

% -----------------------------------------------------
In \cite{mikhaylov_analysis_2016},
	multiple annuli LoRaWAN R cell structure is well modelled and illustrated with a few applicative scenarios.
This structure is considered in our article but channel effects and capture effect are added to our model thus making it more complete and realistic.

% -----------------------------------------------------
In \cite{goursaud_random_2016},
	the performances of a random Frequency Division Multiple Access (random FDMA) scenario are studied in the pure Aloha case,
	but the capture effect with little overlap between packets is not considered.

% -----------------------------------------------------
In \cite{reynders_range_2016},
	the performances in terms of packet delivery ratio and throughput of LoRaWAN R

and Sigfox R are simulated.
However,
	the simulation process and the numerous network parameters are not exposed enough thus lacking of transparency and possibility of reuse.

% -----------------------------------------------------
In \cite{adelantado_understanding_2017},
	some interesting insights on the limits of LoRaWAN R are given,
	but again the model is based on Poisson process and there is no possible extension to account for the capture effect.
In this article,
	in order to give the limit of the performance,
	we study the outage probability and throughput of LoRaWAN R and Sigfox R when every node is transmitting as frequently as possible,
	according to either the ISM band duty cycle constraints or technology-related constraints,
	which result in message sending periods in the order of 1 to 10 minutes.
This scenario of the saturation throughput could be that of packet and object tracking systems [The internet of things:
	a survey.
Information Systems Frontiers].
Other less frequent IoT scenarios such as water \& gas metering can be evaluated using our model thanks to its flexibility.

\cite{magrin_thorough_2019} J8NXUG9T

In the last years,
	the LoRaWAN technology has been the subject of many studies,
	which analyzed its performance and features with empirical measurements,
	mathematical analysis and simulative tools.

% -----------------------------------------------------
Some seminal papers on LoRaWAN such as \cite{petajajarvi_coverage_2015},
	\cite{wixted_evaluation_2016} test the coverage range and packet loss ratio by means of empirical measurements,
	but without investigating the impact of the parameters setting on the performance.

% -----------------------------------------------------
Other works,
	such as \cite{bor_lora_2017},
	examine the impact of the modulation parameters on the single communication link between an ED and its GW,
	without considering more complex network configurations.
2 Note that,
	from the GW perspective,
	ACK packets are not distinguishable from any other DL packet and,
	hence,
	are subject to the same rules and constraints.

% -----------------------------------------------------
To obtain more general results,
	\cite{li_2d_2016} uses a stochastic geometry model to jointly analyze interference in the time and frequency domains.
It is observed that when implementing a packet repetition strategy,
	i.e.,
	transmitting each message multiple times,
	the failure probability reduces,
	but clearly the average throughput decreases because of the introduced redundancy.

% -----------------------------------------------------
In \cite{ferre_collision_2017} the author proposes closed-form expressions for collision and packet loss probabilities and,
	under the assumption of perfect orthogonality between SFs,
	it is shown that the Poisson distributed process does not accurately model packet collisions in LoRaWAN.
Network throughput,
	latency and collision rate for uplink transmissions are analyzed in \cite{sorensen_analysis_2017} that,
	using queueing theory and considering the Aloha channel access protocol and the regulatory constrains in the use of the different sub-bands,
	points out the importance of a clever splitting of the traffic in the available sub-bands to improve the network performance.

% -----------------------------------------------------
In \cite{bankov_mathematical_2017} the authors present a mathematical model of the network performance,
	taking into account factors such as the capture effect and a realistic distribution of SFs in the network.
However,
	the model does not include some important network parameters,
	preventing the study of their effect on the network perfomance.

% -----------------------------------------------------
A step further is made in \cite{capuzzo_mathematical_2018} where the authors develop a model that makes it possible to consider various parameters configurations,
	such as the number of ACKs sent by the GW,
	the SF used for the downlink transmissions,
	and the DC constraints imposed by the regulations.
In this work,
	however,
	multiple retransmissions have not been considered.

% -----------------------------------------------------
The study presented in \cite{pop_does_2017} features a system-level analysis of LoRaWAN,
	and gives significant insights on bottlenecks and network behavior in presence of downlink traffic.
However,
	besides pointing out some flaws in the design of the LoRaWAN medium access scheme,
	this work does not propose any way to improve the performance of the technology.

% -----------------------------------------------------
In \cite{abeele_scalability_2017},
	system-level simulations are again employed to assess the performance of confirmed and unconfirmed messages and show the detrimental impact of confirmation traffic on the overall network capacity and throughput.
Here,
	the only proposed solution is the use of multiple gateways,
	without deeply investigating the specificities of the LoRaWAN standard.

% -----------------------------------------------------
In \cite{reynders_lorawan_2018} a module for the ns-3 simulator is proposed and used for a similar scope,
	comparing the singleand multigateway scenarios and the use of unconfirmed and confirmed messages.
In this case,
	the authors correctly implement the GW’s multiple reception paths,
	but do not take into account their association to a specific UL frequency,
	which usually occurs during network setup:
	indeed,
	the number of packets that can be received simultaneously on a given frequency can not be greater than the number of reception paths that are listening on that frequency.
Also in this case,
	the study only focuses on the performance analysis,
	without proposing any improvement.

% -----------------------------------------------------
The authors in \cite{hauser_proposal_2017},
	\cite{slabicki_adaptive_2018} target the original ADR algorithm proposed by [thethingsnetwork.org],
	suggesting possible ameliorations.
Generally,
	the modified algorithms yield an increase of network scalability,
	fairness among nodes,
	packet delivery ratio and robustness to variable channel conditions.

% -----------------------------------------------------
In \cite{reynders_power_2017},
	the authors compute the optimal SFs distribution to minimize the collision4 probability and propose a scheme to improve the fairness for nodes far from the station by optimally assigning SFs and transmit power values to the network nodes,
	in order to reduce the packet error rate.

% -----------------------------------------------------
In \cite{kouvelas_employing_2018} it is shown how the use of a persistent-Carrier Sense Multiple Access (p-CSMA) MAC protocol when transmitting UL messages can improve the packet reception ratio.
However,
	attention must be payed to the fact that having many EDs that defer their transmission because of a low value of p may lead to channel under-utilization.

% -----------------------------------------------------
In \cite{zucchetto_uncoordinated_2017},
	the authors investigate,
	via simulation,
	the impact of DC restrictions in LPWAN scenarios,
	showing that rate adaptation capabilities are indeed pivotal to maintain reasonable level of performance when the coverage range and the cell load increase.
However,
	the effect of other parameters setting on the network performance is not considered.
In this study we differ from the existing literature in that we target large networks with bidirectional traffic,
	a scenario that makes it possible to observe some unforeseen effects rising from the interaction of multiple nodes served by one single GW and NS.
Furthermore,
	in our analysis we examine one by one the role played by the configurable network parameters,
	as detailed in Sec.IV-A,
	thus highlighting some pitfalls that can affect the network performance.
We then propose possible counteractions that require some small changes at the MAC layer,
	and we evaluate their effectiveness in some representative scenarios.
As a side result,
	we enriched the ns-3 lorawan module with new functionalities.

\cite{marais_evaluating_2019} AXRU35IH

Performance evaluations of the LoRaWAN protocol frequently consist of a network with a single gateway and one or two nodes with which measurements are taken at several identified points \cite{marais_lora_2017},
	\cite{aref_free_2014},
	\cite{petajajarvi_coverage_2015},
	\cite{augustin_study_2016}.
These provide valuable insights but can produce results impacted by device specific characteristics.
Experiments on nodes in motion showed that at speeds higher than 40 km/h,
	the communication performance worsens due to the Doppler effect \cite{petajajarvi_performance_2017},
	\cite{sanchez-iborra_performance_2018}.
Extensive research regarding the ADR scheme has resulted in additions and modifications targeting network performance metrics such as scalability \cite{kim_adaptive_2017},
	throughput \cite{cuomo_explora_2017},
	PDR \cite{reynders_power_2017},
	and contention \cite{kim_contention-aware_2018}.
As an example,
	congestion estimation is achieved through evaluation of network throughput,
	RSSI and the number of connections at a gateway before nodes are sent LinkADRReq messages \cite{kim_adaptive_2017}.
Fair Adaptive Data Rate (FADR) uses Received Signal Strength Indicator (RSSI) values in its calculations when determining SF and Transmit Power (Tx) assignments [Poster:
	A Fair Adaptive Data Rate Algorithm for LoRaWAN].

% -----------------------------------------------------
In \cite{hauser_proposal_2017},
	additions such as adjusting data rates before incrementing Tx,
	the averaging of SNR history and accounting for hysteresis is recommended.

% -----------------------------------------------------
A contention aware ADR approach,
	proposed by \cite{kim_contention-aware_2018},
	tracks the number of nodes per SF and aims to increase the number of devices using low SFs in order to maximise the network’s throughput.

% -----------------------------------------------------
In \cite{sanchez-iborra_performance_2018},
	the influence of variation in payload length was tested and a definite PDR improvement was observed,
	which was however not consistent over the range of data rates evaluated.
The payload length experiments conducted in \cite{aref_free_2014} found similar inconsistencies,
	with similar PDRs for 10 and 100 bytes but a decrease for 50 bytes.
Performance evaluations in urban,
	suburban and rural environments resulted in coverage of around 6 km in urban and suburban areas with over 18 km in the rural scenario \cite{sanchez-iborra_performance_2018}.
The urban evaluation,
	which enabled ACKs,
	showed a PDR of 100 \% for DR0 to DR5 for distances below 3 km,
although over how many packets this was calculated was not specified.
Even at distances between 5 km and 6 km,
	a 100 \% PDR achieved
when DR0 was used,
	however,
	other data rates resulted in lower PDRs of between 30 \% and 50 \%.
Tests on ACK requests by nodes in an evaluation of a three gateway LoRaWAN,
	found that in 2.5 \% of cases the data
arrived but the device did not receive an ACK which could result in unnecessary retries \cite{wixted_evaluation_2016}.
To investigate the impact of downlink traffic in which ACKs materially influence performance,
	the popular LoRaSim simulator was extended into LoRaWANSim \cite{pop_does_2017}.
Evaluation of the effects of increased network size showed that a gateway will reach its duty cycle limits when attempting to transmit all of the required ACKs.
The use of ACKs has a major impact on performance in large networks and greatly reduce their capacity \cite{pop_does_2017}.
Tests on a single gateway network found that ACKs only improved the PDR for a low number of devices (100, 500 and 1000) and only when data was sent every sixty thousand seconds \cite{abeele_scalability_2017}.

\cite{pop_does_2017} TVTNCP95

As we present a simulator for LoRaWAN LPWA networks,
	we briefly discuss related tools and studies on LoRaWAN.
A.
LoRaWAN Analytical Models and Simulators Multiple analytical models [Analysis of the delay of conﬁrmed downlink frames in Class B of LoRaWAN],
	\cite{georgiou_low_2017},
	\cite{toussaint_performance_2016} and simulators \cite{bor_lora_2016},
	[Massive Access for Machine-to-Machine Communication in Cellular Networks],
	[github.com/maartenweyn/lpwansimulation] have been proposed to understand the performance of LoRaWAN.
None of these models is provide any insights on the interplay between downlink traffic and the gateway’s duty cycle limit or effect of MAC parameter settings on the reliability of LoRaWAN.
To bridge this gap,
	we design LoRaWANSim,
	which extends the functionalities of LoRaSim \cite{bor_lora_2016},
	an existing discrete event simulator.
Other simulators [Massive Access for Machine-to-Machine Communication in Cellular Networks],
	[github.com/maartenweyn/lpwansimulation] including LoRaSim focus more on LoRa physical layer aspects,
	including modulation,
	channel effects,
	and path loss.
Unfortunately,
	their MAC layer capabilities are very much limited to an implementation of the ALOHA protocol.
With LoRaWANSim,
	we take an important step forward by incorporating multiple MAC layer features that are part of the LoRaWAN standard.
These features include the possibility to send downlink traffic,
	special control messages,
	confirmed messages,
	acknowledgments,
	and retransmissions.
By doing so,
	LoRaWANSim enables users to evaluate the performance of the LoRaWAN MAC layer,
	derive useful insights about the effect of several MAC layer parameters,
	and evaluate possible enhancements to the LoRaWAN standard.

\cite{sandoval_optimal_2018} PVJDK4XI

Long range technologies such as LoRa [lora-alliance.org] and Sigfox [sigfox.com] have started to draw significant attention from the academic and industrial communities.
Some of the published works in this field devote their efforts to analyzing the performance of real LPWAN deployments under different conditions:
	IoT devices monitoring civil infrastructures such as bridges [Vibrations powered LoRa sensor:
	An electromechanical energy harvester working on a real bridge],
	LoRa-based video surveillance systems [Deploying a pool of long-range wireless image sensor with shared activity time],
	health monitoring motes \cite{petajajarvi_evaluation_2017},
	etc.
On the other hand,
	some other studies are focused on analyzing the advantages,
	disadvantages,
	capabilities,
	and limits of the current implementations of these technologies from a technological point of view.
For example,
	the real scalability of current LoRa networks [Do LoRa Low-Power Wide-Area Networks Scale],
	\cite{georgiou_low_2017},
	the performance of their different configurations \cite{bor_lora_2017},
	and how these types of networks tolerate download traffic \cite{pop_does_2017},
	amongst other things are being studied.
Although they are very practical and illustrating,
	none of these works optimizes or analyzes the performance of LPWAN in a generic and theoretic fashion,
	which would allow their extrapolation to different technologies (LoRa,
	Sigfox,
	etc.) or their future implementations,
	beyond current transceivers.
As a notable exception,
	[Analysis of Latency and MAC-layer Performance for Class A LoRaWAN,] studied the impact of sub-band selection on LoRa motes by modeling nodes as an infinite,
	jockeying M/M/c queue (i.e.
c servers,
	arrivals determined by a Poisson process,
	and exponentially distributed job services).
Although the work is very well detailed,
	mathematically neat and applicable to future deployments,
	it does not capture the true,
	complex nature of real Long-Range networks,
	where resources are very scarce (i.e.
infinite queues are impossible to implement) and traffic cannot always be assumed to follow a certain distribution.
Regarding the TDC-limitation problem,
	two works [QoS for Long-Range Wireless Sensors Under Duty-Cycle Regulations with Shared Activity Time Usage],
	[Deploying a pool of long-range wireless image sensor with shared activity time] have recently highlighted the importance of TDC-aware networks by illustrating the problem of transmitting real-time video in Long-Range deployments.
Although practical,
	the solution proposed focuses on deliberately breaking the 36s/hour TDC limitation by complying with it in a network-aggregated fashion (i.e.
the average network TDC is kept below 36s/hour,
	not the per-node TDC).
In fact,
	\cite{adelantado_understanding_2017} highlighted that the effects of TDC limitations jeopardize the actual capacity of largescale deployments,
	and the only de-facto proposal to manage it,
	a fixed limit on the number of permitted messages per day,
	fails to provide the network with enough flexibility.
With the interest of contributing to fill the notable gap in research,
	we propose an approach to derive MDP-based transmission policies that fully comply with the TDC regulations while maximizing the number of high-priority reported events.

\cite{yang_smart_2018} U5RX6JLY

LoRaWAN is a wireless communication protocol and has got more and more researches in recent years.
Its application domains include smart agriculture,
	security city,
	river bank monitoring and street lighting control.
However,
	LoRaWAN employs simple random access schemes that may suffer from important latency and low data delivery,
	which are key performance indicators in smart elderly care networks.
Some researches focus on the features and performance of LoRaWAN.

% -----------------------------------------------------
Rémi Bonnefoi,
	et al\cite{bonnefoi_improvement_2018} present reinforcement learning algorithms to reduce the collision probability and the network latency.

% -----------------------------------------------------
Jaehyu Kim,
	et al \cite{kim_secure_2018} propose a secure device-to-device link establishment scheme to guarantee security features in LoRaWAN and evaluated the performance by comparing the energy consumption.

% -----------------------------------------------------
Ramon Sanchez-Iborra,
	et al\cite{sanchez-iborra_performance_2018-1} evaluate the performance of LoRaWAN on different real scenarios.
Also the energy consumption is considered by some researchers.

% -----------------------------------------------------
Analytical models of energy consumption and the performance of LoRaWAN are analyzed by Lluís Casals,
	et al \cite{casals_modeling_2017}.
The impact of LoRa transmission parameter selection on communication performance is presented by Bor,
	Martin;
	Roedig,
	Utz \cite{bor_lora_2017},
	a link probing regime to save energy consumption and improve communication reliability is also developed.

% -----------------------------------------------------
Considering energy constraints of wireless sensor networks iin IoT,
	Fadi Al-Turjman,
	et al \cite{al-turjman_mobile_2017} propose a novel traffic model to investigate the effects of multi-hop communication of IoT.
C.
Tunc,
	et la \cite{tunc_markov_2017} present a Markov fluid queue model for energy management to prolong the lifetime of IoT.
For Markov model itself,
	a classical single server vacation model is generalized by Servi and Finn to consider a server in a WDM optical access network.\cite{servi_m/m/1_2002}.
Wang and Chang exploit the equilibrium joining strategies for customers in an M/M/1 queue with working vacations and vacation interruptions \cite{li_equilibrium_2016}.
Kempa and Kobielnik consider a single-channel finite-buffer queuing model with a general independent input stream of customers \cite{kempa_transient_2018}.
Besides the characteristics of LoRaWAN network researches,
	the applications in industry and IoT are also attracted some researchers’ attention.
A solution is proposed in article \cite{navarro-ortiz_integration_2018} aims to integrate LoRaWAN with 4G/5G mobile networks,
	which will allow the current infrastructures of mobile network operators are reutilized.

% -----------------------------------------------------
On the contrary,
	although LoRaWAN is rising with a promising future,
	Adelantado,
	et al\cite{adelantado_understanding_2017} give an objective description of limitations of LoRaWAN in accordance with the development questions in research and application.

% -----------------------------------------------------
Pedro Cruz,
	et al \cite{cruz_algorithm_2019} address the IoT utilization of the public transportation system in smart city.

% -----------------------------------------------------
The combined use of IoT with industrial sensors in structural health monitoring is given by Luis Alonso,
	et al \cite{alonso_middleware_2018}.


% -----------------------------------------------------
Antonis Tzounis,
	et al \cite{song_internet_2017}\cite{tzounis_internet_2017} discuss the IoT solutions towards the modernization of agriculture and present a survey of IoT technologies in the agricultural sector.

% -----------------------------------------------------
Yonghua Songa,
	et al \cite{song_internet_2017} propose a IoT solution in energy management system based on the LPWAN technology.

% -----------------------------------------------------
René Brandborg Sørensen,
	et al \cite{sorensen_analysis_2017} have investigated the performance of LoRaWAN including delay,
	collision rate,
	and throughput.
These articles have provided valuable works for the research in this paper.
According to the literature review,
	most of the works about LoRa has focused on the study of the network characteristics such as coverage,
	time delay,
	or energy consumption.
As we know,
	the network performance and the availability such as collision rate and SDR are significant in elderly care solutions.
Moreover,
	the data delivery policy among the nodes and the gateway in the star topology network is very important for avoiding packets collision and increasing SDR.
But it has been carried out limited studies.
Therefore,
	we mainly focus on the performance improvement and optimal cluster allocation policies for maximizing SDR in LoRaWAN.
The network QoS factors,
	including average time delay,
	SDR and energy consumption,
	are analyzed.
Based on this topic,
	a smart WPSN solution in elderly care system is implemented and evaluated experimentally.

\cite{zhou_novel_2019} ZRKCKJY9

Transmission parameter configuration mechanisms such as ADR scheme need to be executed on both LoRa node and LoRa network server.
Taking into account low power consumption,
	the mechanism running on LoRa node should be as simple as possible and has been detailed in LoRaWAN.
However,
	LoRa network server is responsible for the complex management mechanism,
	which can be carefully designed to improve network performance.
Therefore,
	the discussed related works focus on server-side mechanism.
In addition,
	the mechanism running on LoRa node is in accordance with the definition of LoRaWAN 1.1 specification [LoRaWAN Speciﬁcation].
The basic ADR scheme provided by LoRaWAN estimates channel conditions using the maximum value of the received signal-to-noise ratio (SNR) in several recent packets [LoRaWAN Speciﬁcation].
When the variance of the channel is low,
	using ADR scheme significantly reduces the interference and increases the system capacity compared with using the static data rate \cite{bor_lora_2016},
	\cite{slabicki_adaptive_2018},
	\cite{zheng_smdp-based_2015}.
However,
	the scheme may also have potential drawbacks.
First,
	SNR measurements are determined by different models of LoRa Gateway.
Therefore,
	the value of SNR is inaccurate as a result of hardware calibration and interfering transmissions.
Second,
	selecting the maximum SNR in the last 20 packets is not an desirable method.
Because there may be a long time interval between consecutive packets for some IoT applications.
The antiquated SNR information is not able to accurately estimate the channel condition for the next uplink packet.
Third,
	the scheme only considers the link of single node to decide whether to adjust transmission parameters.
If massive LoRa nodes are densely distributed near LoRa Gateway,
	it will cause most of nodes using the fastest data rate.
With the number of LoRa nodes using the same data rate increases,
	the possibility of collisions also increases dramatically.
Moreover,
	a lot of researchers propose various approaches to allocate transmission parameters with different objectives.
Most of the approaches utilize SNR or RSSI information to control transmission power and spreading factor.
The authors in \cite{slabicki_adaptive_2018} slightly modify the basic ADR scheme.
The maximum operation in the SNR of several recent packets is replaced with the average function.

% -----------------------------------------------------
In \cite{cuomo_explora_2017},
	EXPLoRa-SF selects spreading factors based on the total number of connected nodes and EXPLoRa-AT equalizes the time-on-air of packets transmitted at the different spreading factors.

% -----------------------------------------------------
In addition,
	the authors in \cite{bor_lora_2017} propose an link probing regime to select transmission parameters in order to achieve lower energy consumption.

% -----------------------------------------------------
In \cite{reynders_power_2017},
	the authors present a scheme to optimize the packet error rate fairness to avoid near-far problems.

\cite{zhu_improving_2019} IWAC4Y9B

LoRa,
	a proprietary wireless communication standard promoted by the LoRa alliance,
	enables long-range communications.
Even though the typical topology in LoRa is a single-hop network named LoRaWAN [LoRaWAN specification],
	\cite{pop_does_2017},
	the SF allocation is an important issue because it improves the network efficiency in both single-hop and multi-hop LoRa networks.
A.
SF ALLOCATION IN A SINGLE-HOP NETWORK LoRaWAN,
	which is a single-hop network,
	implements an ALOHA or a slotted ALOHA mechanism on the Medium Access Control (MAC) layer with the physical design of LoRa technology \cite{mahmood_scalability_2019}.
LoRaWAN ensures connectivity by standardizing the Adaptive Date Rate (ADR) mechanism to allow the node to step down its data rate.
However,
	the ADR,
	which is based on the number of received acknowledgment (ACK) messages from gateways,
	is a basic method.
These methods are inaccurate for assessing the highlyvarying wireless environment,
	and render data transmission inefficient \cite{kim_adaptive_2017}.
Subsequent research  \cite{adelantado_understanding_2017}
\cite{reynders_power_2017}
\cite{reynders_improving_2018}
\cite{slabicki_adaptive_2018}
considered an SF distribution scheme based only on the distance from the node to gateways.

% -----------------------------------------------------
Adelantado et al.
\cite{adelantado_understanding_2017} showed that an excessive number of nodes (28 \% of the network) should use the largest SF
(SF12) to ensure the coverage of urban cells.
This approach only considered the path loss and ignored the airtime when using SF12.

% -----------------------------------------------------
Reynders et al.
\cite{reynders_improving_2018} provided SF distribution scheme to balance the packet error rate \cite{reynders_power_2017} and lightweight scheduling to group the nodes into different power level and selected SFs to improve the reliability and scalability of the LoRaWAN network.

% -----------------------------------------------------
Slabicki et al.
\cite{slabicki_adaptive_2018} showed that a network-aware approach can further improve the delivery ratio of dense networks by using global knowledge of the node locations.
However,
	the proposed algorithms based on ADR are not considered in the same way as for parallel transmission.

% -----------------------------------------------------
Cuomo et al.
\cite{cuomo_explora_2017} extended the work on parallel transmission in a single-hop LoRa network.
Specifically,
	these authors proposed to use the airtime to balance the nodes of each group with a specific SF and to attempt to use a high data rate to offload the traffic to less congested larger SFs.
However,
	these strategies cannot be easily applied to a multi-hop LoRa network because of their lack of consideration in regards to multi-hop relays.
In contrast to a single hop network in which the airtime of different groups is only decided by the number of nodes and their data rates,
	the airtime in a multi-hop network is also determined by the hop count of each subnet.
Moreover,
	the connectivity between multiple relays is still not considered when conducting SF allocation in a single-hop LoRa network.
B.
SF ALLOCATION IN A MULTI-HOP NETWORK As compared to single-hop LoRa networks,
	multi-hop networks are more flexible to extend the coverage and more efficient to improve the data transmission without increasing the number of gateways.
A practical strategy that transforms the topology from a star to a mesh network when the coverage range exceeds 3.2 km was proposed \cite{ochoa_evaluating_2017}.

% -----------------------------------------------------
Moreover,
	it was shown \cite{ke_lora_2017} that constructing a mesh LoRa network is a good solution to solve the coverage problem in extensively shadowed urban areas.
However,
	few reports that discuss the SF allocation in a mesh LoRa network have been published.
On the other hand,
	similar to SF allocation in a mesh LoRa network,
	the adoption of parallel transmission by using multiple channels has already been implemented in conventional multi-hop single-root data collection networks.

% -----------------------------------------------------
In data collection networks,
	the proposed protocols \cite{wu_realistic_2008},
	\cite{liew_fast_2018} usually construct a static channel assignment approach to maintain the simplicity of channel coordination.

% -----------------------------------------------------
Other researchers \cite{wu_realistic_2008} proposed TMCP to assign different channels to disjoint trees and operate parallel transmissions among sub-trees for data collection.
However,
	the paper does not discuss the balance between different sub-trees.

% -----------------------------------------------------
A more recent proposal \cite{liew_fast_2018} involved a multi-channel multi-path data collection protocol based on Basketball Net Topology (BNT),
	which maintains not only a tree-based topology but also the connectivities between peer nodes located at the same height in the tree.
This protocol enables child nodes to rejoin the network,
	even when their parent node disappeared from the original tree structure,
	by using peer links to communicate with other nodes.
However,
	the connectivities of peers extend the hop counts to the sink node,
	which inversely increases the airtime of the entire network.
The use of LoRa enables the coverage range to be extended when a lower data rate with a larger SF is chosen.
As compared to multi-channel assignment algorithms,
	we needed to consider an approach that would decrease the hop count of each sub-tree using a different SF while ensuring that the airtime between different sub-trees remains balanced.

